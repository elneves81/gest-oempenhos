<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Modal Anota√ß√µes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>üß™ Teste Modal Anota√ß√µes</h1>
        
        <div class="alert alert-info">
            <h5>Status do Servidor</h5>
            <div id="serverStatus">Verificando...</div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Teste de Envio de Anota√ß√µes</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="textoTeste" class="form-label">Texto da Anota√ß√£o</label>
                    <textarea class="form-control" id="textoTeste" rows="3" placeholder="Digite uma anota√ß√£o de teste..."></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="arquivoTeste" class="form-label">Anexo (opcional)</label>
                    <input class="form-control" id="arquivoTeste" type="file" multiple>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="testarSoTexto()">
                        <i class="bi bi-chat-left-text me-1"></i>Testar S√≥ Texto
                    </button>
                    <button type="button" class="btn btn-success" onclick="testarComAnexos()">
                        <i class="bi bi-save me-1"></i>Testar Com Anexos
                    </button>
                </div>
                
                <div class="mt-3">
                    <h6>Resultado:</h6>
                    <div id="resultadoTeste" class="border p-2 bg-light"></div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Anota√ß√µes Existentes</h5>
            </div>
            <div class="card-body">
                <button type="button" class="btn btn-outline-primary" onclick="carregarAnotacoes()">
                    <i class="bi bi-refresh me-1"></i>Carregar Anota√ß√µes
                </button>
                <div id="listaAnotacoesTeste" class="mt-2"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Verificar status do servidor
        async function verificarServidor() {
            try {
                const response = await fetch('/contratos/', { method: 'HEAD' });
                document.getElementById('serverStatus').innerHTML = 
                    `<span class="text-success">‚úÖ Servidor OK (Status: ${response.status})</span>`;
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = 
                    `<span class="text-danger">‚ùå Servidor n√£o responde: ${error.message}</span>`;
            }
        }

        // Testar envio s√≥ texto
        async function testarSoTexto() {
            const texto = document.getElementById('textoTeste').value.trim();
            if (!texto) {
                alert('Digite um texto de teste!');
                return;
            }

            const resultado = document.getElementById('resultadoTeste');
            resultado.innerHTML = '<span class="text-info">üîÑ Enviando...</span>';

            try {
                const fd = new FormData();
                fd.append('texto', texto);

                const response = await fetch('/contratos/1/anotacoes', {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                });

                const data = await response.json();
                
                if (data.success) {
                    resultado.innerHTML = `<span class="text-success">‚úÖ Sucesso! ID: ${data.anotacao?.id}</span>`;
                    document.getElementById('textoTeste').value = '';
                } else {
                    resultado.innerHTML = `<span class="text-danger">‚ùå Erro: ${data.error}</span>`;
                }
            } catch (error) {
                resultado.innerHTML = `<span class="text-danger">‚ùå Erro de conex√£o: ${error.message}</span>`;
            }
        }

        // Testar envio com anexos
        async function testarComAnexos() {
            const texto = document.getElementById('textoTeste').value.trim();
            const arquivos = document.getElementById('arquivoTeste').files;
            
            if (!texto) {
                alert('Digite um texto de teste!');
                return;
            }

            const resultado = document.getElementById('resultadoTeste');
            resultado.innerHTML = '<span class="text-info">üîÑ Enviando com anexos...</span>';

            try {
                const fd = new FormData();
                fd.append('texto', texto);
                
                // Adicionar arquivos se selecionados
                for (const arquivo of arquivos) {
                    fd.append('arquivos', arquivo, arquivo.name);
                }

                const response = await fetch('/contratos/1/anotacoes', {
                    method: 'POST',
                    body: fd,
                    credentials: 'same-origin'
                });

                const data = await response.json();
                
                if (data.success) {
                    const anexos = data.anotacao?.anexos?.length || 0;
                    resultado.innerHTML = `<span class="text-success">‚úÖ Sucesso! ID: ${data.anotacao?.id}, Anexos: ${anexos}</span>`;
                    document.getElementById('textoTeste').value = '';
                    document.getElementById('arquivoTeste').value = '';
                } else {
                    resultado.innerHTML = `<span class="text-danger">‚ùå Erro: ${data.error}</span>`;
                }
            } catch (error) {
                resultado.innerHTML = `<span class="text-danger">‚ùå Erro de conex√£o: ${error.message}</span>`;
            }
        }

        // Carregar anota√ß√µes existentes
        async function carregarAnotacoes() {
            const lista = document.getElementById('listaAnotacoesTeste');
            lista.innerHTML = '<span class="text-info">üîÑ Carregando...</span>';

            try {
                const response = await fetch('/contratos/1/anotacoes', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                const data = await response.json();
                
                if (data.success) {
                    const anotacoes = data.anotacoes || [];
                    lista.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ ${anotacoes.length} anota√ß√µes encontradas
                        </div>
                        ${anotacoes.slice(0, 3).map(a => `
                            <div class="border-bottom pb-2 mb-2">
                                <strong>ID:</strong> ${a.id}<br>
                                <strong>Texto:</strong> ${a.texto}<br>
                                <strong>Anexos:</strong> ${a.anexos?.length || 0}<br>
                                <strong>Data:</strong> ${a.data_criacao}
                            </div>
                        `).join('')}
                    `;
                } else {
                    lista.innerHTML = `<span class="text-danger">‚ùå Erro: ${data.error}</span>`;
                }
            } catch (error) {
                lista.innerHTML = `<span class="text-danger">‚ùå Erro de conex√£o: ${error.message}</span>`;
            }
        }

        // Verificar servidor ao carregar p√°gina
        document.addEventListener('DOMContentLoaded', verificarServidor);
    </script>
</body>
</html>

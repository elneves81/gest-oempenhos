<div class="widget-content" id="widget-orcamento">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h6 class="widget-title mb-0">
      <i class="bi bi-pie-chart text-primary"></i> Orçamento
    </h6>
    <div class="btn-group btn-group-sm">
      <button class="btn btn-outline-primary btn-sm" onclick="abrirModalOrcamento()">
        <i class="bi bi-plus"></i>
      </button>
      <button class="btn btn-outline-info btn-sm" onclick="abrirRelatorioOrcamento()">
        <i class="bi bi-file-text"></i>
      </button>
    </div>
  </div>
  
  <div id="orcamento-resumo" class="widget-body">
    <div class="spinner-border spinner-border-sm" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>
  
  <div class="mt-2">
    <div class="progress" style="height: 8px;">
      <div id="progress-empenhado" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
      <div id="progress-liquidado" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
      <div id="progress-pago" class="progress-bar bg-dark" role="progressbar" style="width: 0%"></div>
    </div>
    <small class="text-muted">
      <span class="badge bg-warning">Empenhado</span>
      <span class="badge bg-success">Liquidado</span> 
      <span class="badge bg-dark">Pago</span>
    </small>
  </div>
</div>

<!-- Modal para Novo Empenho Orçamentário -->
<div class="modal fade" id="modalOrcamento" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Novo Empenho Orçamentário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formOrcamento">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Órgão *</label>
              <select class="form-select" name="orgao" required>
                <option value="">Selecione...</option>
                <option value="SECRETARIA DE EDUCACAO">Secretaria de Educação</option>
                <option value="SECRETARIA DE SAUDE">Secretaria de Saúde</option>
                <option value="SECRETARIA DE OBRAS">Secretaria de Obras</option>
                <option value="PREFEITURA MUNICIPAL">Prefeitura Municipal</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Unidade</label>
              <input type="text" class="form-control" name="unidade" placeholder="Ex: ESCOLA MUNICIPAL">
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-4">
              <label class="form-label">Fonte *</label>
              <select class="form-select" name="fonte" required>
                <option value="">Selecione...</option>
                <option value="RECURSOS PROPRIOS">Recursos Próprios</option>
                <option value="FUNDEB">FUNDEB</option>
                <option value="SUS">SUS</option>
                <option value="CONVENIO">Convênio</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Categoria *</label>
              <select class="form-select" name="categoria" required>
                <option value="">Selecione...</option>
                <option value="PESSOAL">Pessoal</option>
                <option value="CUSTEIO">Custeio</option>
                <option value="INVESTIMENTO">Investimento</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Ano *</label>
              <select class="form-select" name="ano" required>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
              </select>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <label class="form-label">Valor Empenhado *</label>
              <input type="text" class="form-control money" name="valor_empenhado" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Descrição *</label>
              <input type="text" class="form-control" name="descricao" required placeholder="Descrição do empenho">
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <label class="form-label">Valor Liquidado</label>
              <input type="text" class="form-control money" name="valor_liquidado" value="0,00">
            </div>
            <div class="col-md-6">
              <label class="form-label">Valor Pago</label>
              <input type="text" class="form-control money" name="valor_pago" value="0,00">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="salvarOrcamento()">
          <i class="bi bi-save"></i> Salvar
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Carregamento inicial do widget
document.addEventListener('DOMContentLoaded', function() {
  carregarResumoOrcamento();
});

// Carregar resumo orçamentário
function carregarResumoOrcamento() {
  fetch('/api/orcamentos/resumo?ano=2024')
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        atualizarWidgetOrcamento(data.resumo);
      } else {
        document.getElementById('orcamento-resumo').innerHTML = 
          '<small class="text-danger">Erro ao carregar dados</small>';
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      document.getElementById('orcamento-resumo').innerHTML = 
        '<small class="text-danger">Erro na conexão</small>';
    });
}

// Atualizar widget com dados
function atualizarWidgetOrcamento(resumo) {
  const total = resumo.total || {};
  const dotado = total.dotado || 0;
  const empenhado = total.empenhado || 0;
  const liquidado = total.liquidado || 0;
  const pago = total.pago || 0;
  
  // Calcular percentuais
  const percEmpenhado = dotado > 0 ? (empenhado / dotado) * 100 : 0;
  const percLiquidado = dotado > 0 ? (liquidado / dotado) * 100 : 0;
  const percPago = dotado > 0 ? (pago / dotado) * 100 : 0;
  
  // Atualizar resumo
  document.getElementById('orcamento-resumo').innerHTML = `
    <div class="row text-center">
      <div class="col-6">
        <small class="text-muted">Dotado</small>
        <div class="fw-bold text-primary">R$ ${formatarMoeda(dotado)}</div>
      </div>
      <div class="col-6">
        <small class="text-muted">Empenhado</small>
        <div class="fw-bold text-warning">R$ ${formatarMoeda(empenhado)}</div>
      </div>
    </div>
    <div class="row text-center mt-2">
      <div class="col-6">
        <small class="text-muted">Liquidado</small>
        <div class="fw-bold text-success">R$ ${formatarMoeda(liquidado)}</div>
      </div>
      <div class="col-6">
        <small class="text-muted">Pago</small>
        <div class="fw-bold text-dark">R$ ${formatarMoeda(pago)}</div>
      </div>
    </div>
  `;
  
  // Atualizar barras de progresso
  document.getElementById('progress-empenhado').style.width = percEmpenhado + '%';
  document.getElementById('progress-liquidado').style.width = percLiquidado + '%';
  document.getElementById('progress-pago').style.width = percPago + '%';
}

// Abrir modal para novo empenho
function abrirModalOrcamento() {
  new bootstrap.Modal(document.getElementById('modalOrcamento')).show();
}

// Abrir relatório orçamentário
function abrirRelatorioOrcamento() {
  window.open('/relatorios/orcamento?ano=2024', '_blank');
}

// Salvar novo empenho orçamentário
function salvarOrcamento() {
  const form = document.getElementById('formOrcamento');
  const formData = new FormData(form);
  
  // Converter valores monetários
  formData.set('valor_empenhado', convertMoney(formData.get('valor_empenhado')));
  formData.set('valor_liquidado', convertMoney(formData.get('valor_liquidado')));
  formData.set('valor_pago', convertMoney(formData.get('valor_pago')));
  
  fetch('/api/orcamentos/empenhos', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      bootstrap.Modal.getInstance(document.getElementById('modalOrcamento')).hide();
      form.reset();
      carregarResumoOrcamento(); // Recarregar widget
      showAlert('Empenho cadastrado com sucesso!', 'success');
    } else {
      showAlert(data.message || 'Erro ao salvar empenho', 'error');
    }
  })
  .catch(error => {
    console.error('Erro:', error);
    showAlert('Erro na conexão', 'error');
  });
}

// Formatação de moeda para exibição
function formatarMoeda(valor) {
  return new Intl.NumberFormat('pt-BR', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(valor);
}
</script>

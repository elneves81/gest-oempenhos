<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Sistema Municipal{% endblock %}</title>

  <!-- Bootstrap + Icons (globais) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  {% block extra_head %}{% endblock %}
  {% block extra_css %}{% endblock %}

  <style>
    :root{
      --sb-bg-1:#1fbba6;   /* fundo gradiente A */
      --sb-bg-2:#2ec7bf;   /* fundo gradiente B */
      --sb-text:#f5fffe;
      --sb-text-dim: rgba(255,255,255,.85);
      --sb-active:#ffffff;
      --sb-active-pill: rgba(255,255,255,.15);
      --sb-accent:#0e7a6a; /* linha/indicador */
    }

    body { background-color:#f8f9fa; }

    /* SIDEBAR WRAPPER */
    .sidebar{
      min-height:100vh;
      background: linear-gradient(160deg,var(--sb-bg-1),var(--sb-bg-2));
      padding: 14px 12px;
      border-right: 1px solid rgba(255,255,255,.15);
      position: relative;
      transition: width .2s ease;
    }
    .sidebar-inner{
      height:100%;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* BRAND */
    .sb-brand{
      display:flex; align-items:center; gap:10px;
      color:var(--sb-text); padding:10px 12px; border-radius:12px;
      background: rgba(255,255,255,.06);
    }
    .sb-brand .logo{
      width:36px; height:36px; object-fit:contain; filter:brightness(0) invert(1);
    }
    .sb-brand .title{ font-weight:700; letter-spacing:.2px; }
    .sb-brand small{ color:var(--sb-text-dim); display:block; line-height:1.1; }

    /* TOGGLER (colapsar) - botão flutuante sempre visível */
    .sb-toggle{
      position: absolute;
      top: 16px;
      right: -14px;        /* fica um pouco "para fora" da lateral */
      z-index: 1050;
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.3);
      color: #fff;
      font-size: 0.9rem;
      transition: all .15s ease;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    .sb-toggle:hover{ 
      background: rgba(255,255,255,.25); 
      transform: scale(1.05); 
      color: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
    }

    /* quando colapsa continua no mesmo lugar (visível) */
    .sidebar.collapsed .sb-toggle{ right: -14px; }

    /* MENUS */
    .sb-section{
      color:var(--sb-text-dim);
      font-size:.78rem; font-weight:700; letter-spacing:.08em;
      padding:6px 14px; text-transform:uppercase;
    }
    .menu .nav-link{
      display:flex; align-items:center; gap:10px;
      color:var(--sb-text-dim);
      padding:10px 12px; margin:6px 6px;
      border-radius:12px; position:relative;
      transition: all .18s ease;
      text-decoration:none;
      outline:0;
    }
    .menu .nav-link .icon{ width:22px; text-align:center; font-size:1.05rem; }
    .menu .nav-link .text{ flex:1; }

    .menu .nav-link:hover{
      color:var(--sb-active);
      background: var(--sb-active-pill);
      transform: translateX(2px);
    }
    .menu .nav-link.active{
      color:var(--sb-active);
      background: var(--sb-active-pill);
      box-shadow: 0 4px 14px rgba(0,0,0,.08) inset;
    }
    .menu .nav-link.active::before{
      content:""; position:absolute; left:-2px; top:8px; bottom:8px;
      width:3px; border-radius:3px; background:var(--sb-active);
    }

    /* SUBMENU DROPDOWN */
    .menu-dropdown {
      position: relative;
    }
    .menu-dropdown .dropdown-toggle {
      cursor: pointer;
    }
    .menu-dropdown .dropdown-toggle::after {
      content: '\f282'; /* bi-chevron-down */
      font-family: 'bootstrap-icons';
      margin-left: auto;
      transition: transform 0.2s ease;
    }
    .menu-dropdown.show .dropdown-toggle::after {
      transform: rotate(180deg);
    }
    .menu-dropdown .dropdown-menu {
      position: relative;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
      box-shadow: none;
      display: none;
    }
    .menu-dropdown.show .dropdown-menu {
      display: block;
    }
    .menu-dropdown .dropdown-item {
      color: var(--sb-text-dim);
      padding: 8px 12px 8px 44px;
      margin: 2px 6px;
      border-radius: 8px;
      transition: all .18s ease;
      text-decoration: none;
      font-size: 0.9rem;
    }
    .menu-dropdown .dropdown-item:hover {
      color: var(--sb-active);
      background: var(--sb-active-pill);
      transform: translateX(2px);
    }
    .menu-dropdown .dropdown-item.active {
      color: var(--sb-active);
      background: var(--sb-active-pill);
    }
    .menu-dropdown .dropdown-item .badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      margin-left: 4px;
    }

    /* FOOTER (SAIR) */
    .sidebar-footer{
      margin-top:auto; padding:8px 6px;
    }
    .btn-logout{
      width:100%;
      background: rgba(255,255,255,.10);
      color:var(--sb-text);
      border:1px solid rgba(255,255,255,.35);
      border-radius:12px; padding:10px 14px;
    }
    .btn-logout:hover{ background: rgba(255,255,255,.18); color:#fff; }

    /* Foco acessível */
    .menu .nav-link:focus{
      box-shadow: 0 0 0 3px rgba(255,255,255,.35);
    }

    /* SCROLL agradável */
    .sidebar ::-webkit-scrollbar{ width:8px; }
    .sidebar ::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.25); border-radius:8px; }

    /* Modo COLAPSADO */
    .sidebar.collapsed { width: 78px; transition: width .2s ease; }
    .sidebar.collapsed .sb-brand .title,
    .sidebar.collapsed .sb-brand small,
    .sidebar.collapsed .menu .nav-link .text,
    .sidebar.collapsed .sb-section,
    .sidebar.collapsed .btn-logout span{ display:none; }
    .sidebar.collapsed .menu .nav-link{ justify-content:center; gap:0; padding:10px 8px; }
    .sidebar.collapsed .menu .nav-link .icon{ font-size:1.2rem; }

    /* Main content ajustado para sidebar colapsada */
    .content-area { transition: margin-left .2s ease; }
    .sidebar.collapsed ~ .content-area { margin-left: -120px; }
    
    /* Responsividade melhorada */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 1000; }
      .sidebar.show { transform: translateX(0); }
    }
  </style>
</head>
<body>
  {% if current_user.is_authenticated %}
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <!-- BOTÃO FLUTUANTE FIXO NA BORDA -->
        <button id="sbToggle" class="sb-toggle" type="button" title="Colapsar/Expandir">
          <i class="bi bi-chevron-double-left"></i>
        </button>

        <div class="sidebar-inner">
          <!-- topo: marca (sem botão) -->
          <div class="d-flex align-items-center">
            <div class="sb-brand">
              <img class="logo" src="{{ url_for('static', filename='img/logo_guarapuava.svg') }}" alt="">
              <div>
                <div class="title">Sistema Municipal</div>
                <small>Pref. de Guarapuava</small>
              </div>
            </div>
          </div>

          <!-- seção: geral -->
          <div class="sb-section">Geral</div>
          <div class="menu">
            <a class="nav-link {% if request.endpoint=='painel' %}active{% endif %}"
               href="{{ url_for('painel') }}">
              <i class="bi bi-speedometer2 icon"></i>
              <span class="text">Painel Principal</span>
            </a>

            <a class="nav-link {% if request.endpoint and request.endpoint.startswith('empenhos') %}active{% endif %}"
               href="{{ url_for('empenhos.index') }}">
              <i class="bi bi-file-earmark-text icon"></i>
              <span class="text">Empenhos</span>
            </a>

            <a class="nav-link {% if request.endpoint and request.endpoint.startswith('contratos') %}active{% endif %}"
               href="{{ url_for('contratos.index') }}">
              <i class="bi bi-file-earmark-ruled icon"></i>
              <span class="text">Contratos</span>
            </a>

            <!-- Relatórios com Submenu -->
            <div class="menu-dropdown {% if request.endpoint and request.endpoint.startswith('relatorios') %}show{% endif %}">
              <a class="nav-link dropdown-toggle {% if request.endpoint and request.endpoint.startswith('relatorios') %}active{% endif %}"
                 onclick="toggleDropdown(this)">
                <i class="bi bi-graph-up icon"></i>
                <span class="text">Relatórios</span>
              </a>
              <div class="dropdown-menu">
                <a class="dropdown-item {% if request.endpoint=='relatorios.index' %}active{% endif %}"
                   href="{{ url_for('relatorios.index') }}">
                  <i class="bi bi-bar-chart me-2"></i>Central de Relatórios
                </a>
                <a class="dropdown-item {% if request.endpoint=='relatorios.dashboard_interativo' %}active{% endif %}"
                   href="{{ url_for('relatorios.dashboard_interativo') }}">
                  <i class="bi bi-grid-3x3-gap me-2"></i>Dashboard Interativo
                  <span class="badge bg-primary">NOVO</span>
                </a>
              </div>
            </div>

            {% if current_user.is_admin %}
            <a class="nav-link {% if request.endpoint=='auth.users' %}active{% endif %}"
               href="{{ url_for('auth.users') }}">
              <i class="bi bi-people icon"></i>
              <span class="text">Usuários</span>
            </a>
            {% endif %}
          </div>

          <!-- rodapé -->
          <div class="sidebar-footer">
            <form method="POST" action="{{ url_for('auth.logout') }}">
              {{ csrf_token() if csrf_token is defined else '' }}
              <button type="submit" class="btn btn-logout">
                <i class="bi bi-box-arrow-right me-2"></i> <span>Sair</span>
              </button>
            </form>
          </div>
        </div>
      </nav>

      <!-- Main -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-3 py-3 content-area">
        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
          <h1 class="h3 m-0">{% block page_title %}{% endblock %}</h1>
          <div>{% block page_actions %}{% endblock %}</div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ 'danger' if category=='error' else category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
      </main>
    </div>
  </div>
  {% else %}
    {% block auth_content %}{% endblock %}
  {% endif %}

  <!-- Bootstrap JS (global) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Sidebar Toggle Script -->
  <script>
    (function(){
      const key = 'sb-collapsed';
      const sidebar = document.getElementById('sidebarMenu');
      const btn = document.getElementById('sbToggle');
      const main = document.querySelector('.content-area');

      // aplica estado salvo
      if (localStorage.getItem(key) === '1') {
        sidebar.classList.add('collapsed');
        btn.innerHTML = '<i class="bi bi-chevron-double-right"></i>';
      }

      btn?.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        const collapsed = sidebar.classList.contains('collapsed');
        localStorage.setItem(key, collapsed ? '1' : '0');
        btn.innerHTML = collapsed
          ? '<i class="bi bi-chevron-double-right"></i>'
          : '<i class="bi bi-chevron-double-left"></i>';
      });

      // Responsividade para mobile
      function checkMobile() {
        if (window.innerWidth <= 768) {
          sidebar.classList.remove('collapsed');
        }
      }
      
      window.addEventListener('resize', checkMobile);
      checkMobile();
    })();

    // Função para controlar dropdown do menu
    function toggleDropdown(element) {
      const dropdown = element.parentElement;
      const isOpen = dropdown.classList.contains('show');
      
      // Fecha todos os dropdowns abertos
      document.querySelectorAll('.menu-dropdown.show').forEach(dd => {
        dd.classList.remove('show');
      });
      
      // Abre o dropdown clicado se não estava aberto
      if (!isOpen) {
        dropdown.classList.add('show');
      }
    }

    // Fecha dropdown ao clicar fora
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.menu-dropdown')) {
        document.querySelectorAll('.menu-dropdown.show').forEach(dd => {
          if (!dd.querySelector('.nav-link.active')) {
            dd.classList.remove('show');
          }
        });
      }
    });
  </script>

  <!-- Espaço para scripts por página -->
  {% block extra_js %}{% endblock %}
</body>
</html>

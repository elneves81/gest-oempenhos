{% extends "base.html" %}

{% block title %}Gestão de Contratos{% endblock %}
{% block page_title %}Contratos{% endblock %}

{% block extra_css %}
<style>
/* Botões de ação */
.btn-action { min-width: 40px; border-radius: 6px; transition: all 0.2s ease; }
.btn-action:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

/* Dropdown de ações */
.dropdown-menu { border: 1px solid #e3e6f0; box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,.15); border-radius: .35rem; }
.dropdown-item { padding: .5rem 1rem; transition: all .2s ease; }
.dropdown-item:hover { background-color: #f8f9fc; transform: translateX(3px); }
.dropdown-item.text-danger:hover { background-color: #f8d7da; color: #721c24 !important; }

/* Tabela */
.table th { border-top: none; background-color: #f8f9fc; font-weight: 600; color: #5a5c69; font-size: .85rem; text-transform: uppercase; letter-spacing: .5px; }
.table td { vertical-align: middle; padding: 1rem .75rem; }

/* Badge status */
.badge { font-size: .75rem; padding: .35rem .65rem; border-radius: .25rem; }

/* Truncar texto longo do objeto (2 linhas) */
.text-truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; max-width: 320px; }

/* Hover dos cards */
.card { transition: all 0.2s ease; }
.card:hover { transform: translateY(-2px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); }

/* Modal de anotações */
.modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.modal-body { max-height: 60vh; overflow-y: auto; }
.anotacao-item { border-left: 3px solid #667eea; background: #f8f9fc; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; }

/* Validação elegante */
.is-invalid { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important; animation: shake 0.5s ease-in-out; }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* Feedback de sucesso */
.btn-feedback-success { 
  background-color: #28a745 !important; 
  border-color: #28a745 !important; 
  color: white !important;
  transition: all 0.3s ease;
}

/* Anexos - Cards de arquivo */
.anexo-card {
  transition: all 0.2s ease;
  border: 1px solid #e3e6f0;
}

.anexo-card:hover {
  border-color: #667eea;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Modal PDF */
#modalVisualizarPDF .modal-dialog {
  max-width: 95vw;
}

#modalVisualizarPDF iframe {
  border-radius: 0.375rem;
}

/* Professional Drag & Drop Uploader */
.dropzone { 
  border: 2px dashed #dee2e6; 
  border-radius: 10px; 
  transition: all 0.3s ease; 
  min-height: 120px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.dropzone.dragover { 
  border-color: #007bff; 
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  transform: scale(1.02);
}

.upload-progress { 
  height: 4px; 
  overflow: hidden; 
  border-radius: 2px; 
  background-color: #f8f9fa;
}

.file-queue-item {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  transition: all 0.3s ease;
}

.file-queue-item.uploading {
  border-color: #007bff;
  background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
}

.file-queue-item.success {
  border-color: #28a745;
  background: linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%);
}

.file-queue-item.error {
  border-color: #dc3545;
  background: linear-gradient(135deg, #f8d7da 0%, #f8f9fa 100%);
}

.file-preview-icon {
  width: 40px;
  height: 40px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

.icon-pdf { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
.icon-image { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; }
.icon-word { background: linear-gradient(135deg, #2b5797 0%, #1e3d72 100%); color: white; }
.icon-excel { background: linear-gradient(135deg, #1d7044 0%, #155724 100%); color: white; }
.icon-default { background: linear-gradient(135deg, #6c757d 0%, #545b62 100%); color: white; }
</style>
{% endblock %}

{% block content %}

<script>
// ===== UTILITY FUNCTIONS =====

// Compatibility fix for crypto.randomUUID
function generateUUID() {
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return crypto.randomUUID();
  }
  // Fallback implementation
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Formatação de data melhorada
function fmtData(dataString) {
  if (!dataString) return 'N/A';
  try {
    const dt = new Date(dataString);
    if (isNaN(dt.getTime())) return 'Data inválida';
    return dt.toLocaleDateString('pt-BR', {
      day: '2-digit',
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('Erro ao formatar data:', error);
    return 'Erro na data';
  }
}

// ===== FILE UPLOAD SYSTEM =====

class ProfessionalUploader {
  constructor(containerId, contratoId) {
    this.container = document.getElementById(containerId);
    this.contratoId = contratoId;
    this.fileQueue = [];
    this.init();
  }
  
  init() {
    this.setupDropzone();
    this.setupFileInput();
  }
  
  setupDropzone() {
    const dropzone = this.container.querySelector('.dropzone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, this.preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => dropzone.classList.add('dragover'), false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, () => dropzone.classList.remove('dragover'), false);
    });
    
    dropzone.addEventListener('drop', (e) => this.handleDrop(e), false);
  }
  
  setupFileInput() {
    const fileInput = this.container.querySelector('#anexos');
    fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
  }
  
  preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  
  handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    this.handleFiles(files);
  }
  
  handleFiles(files) {
    [...files].forEach(file => this.addToQueue(file));
  }
  
  addToQueue(file) {
    const fileId = generateUUID();
    const fileInfo = {
      id: fileId,
      file: file,
      name: file.name,
      size: file.size,
      type: file.type,
      status: 'pending'
    };
    
    this.fileQueue.push(fileInfo);
    this.renderQueueItem(fileInfo);
  }
  
  renderQueueItem(fileInfo) {
    const queueContainer = this.container.querySelector('.file-queue');
    const icon = this.getFileIcon(fileInfo.type);
    
    const html = `
      <div class="file-queue-item" data-file-id="${fileInfo.id}">
        <div class="d-flex align-items-center">
          <div class="file-preview-icon ${icon.class} me-3">
            <i class="bi ${icon.icon}"></i>
          </div>
          <div class="flex-grow-1">
            <div class="fw-semibold">${fileInfo.name}</div>
            <small class="text-muted">${this.formatFileSize(fileInfo.size)}</small>
            <div class="upload-progress mt-1" style="display: none;">
              <div class="progress-bar bg-primary" style="width: 0%"></div>
            </div>
            <div class="status-text mt-1" style="display: none;"></div>
          </div>
          <div class="file-actions">
            <button class="btn btn-sm btn-outline-danger remove-file" data-file-id="${fileInfo.id}">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
      </div>`;
    
    queueContainer.insertAdjacentHTML('beforeend', html);
    
    // Add remove handler
    const removeBtn = queueContainer.querySelector(`[data-file-id="${fileInfo.id}"] .remove-file`);
    removeBtn.addEventListener('click', () => this.removeFromQueue(fileInfo.id));
  }
  
  getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return { class: 'icon-image', icon: 'bi-image' };
    if (mimeType === 'application/pdf') return { class: 'icon-pdf', icon: 'bi-file-earmark-pdf' };
    if (mimeType.includes('word')) return { class: 'icon-word', icon: 'bi-file-earmark-word' };
    if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return { class: 'icon-excel', icon: 'bi-file-earmark-excel' };
    return { class: 'icon-default', icon: 'bi-file-earmark' };
  }
  
  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  removeFromQueue(fileId) {
    this.fileQueue = this.fileQueue.filter(f => f.id !== fileId);
    const element = this.container.querySelector(`[data-file-id="${fileId}"]`);
    if (element) element.remove();
  }
  
  async uploadFiles() {
    const pendingFiles = this.fileQueue.filter(f => f.status === 'pending');
    
    for (const fileInfo of pendingFiles) {
      await this.uploadSingleFile(fileInfo);
    }
  }
  
  async uploadSingleFile(fileInfo) {
    const element = this.container.querySelector(`[data-file-id="${fileInfo.id}"]`);
    const progressBar = element.querySelector('.progress-bar');
    const statusText = element.querySelector('.status-text');
    const progressContainer = element.querySelector('.upload-progress');
    
    // Show progress
    progressContainer.style.display = 'block';
    element.classList.add('uploading');
    fileInfo.status = 'uploading';
    
    const formData = new FormData();
    formData.append('anexo', fileInfo.file);
    
    try {
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percentComplete = (e.loaded / e.total) * 100;
          progressBar.style.width = percentComplete + '%';
        }
      });
      
      const response = await new Promise((resolve, reject) => {
        xhr.onload = () => resolve(xhr);
        xhr.onerror = () => reject(new Error('Erro na requisição'));
        xhr.open('POST', `/contratos/${this.contratoId}/anexos`);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.send(formData);
      });
      
      const result = JSON.parse(response.responseText);
      
      if (result.success) {
        element.classList.remove('uploading');
        element.classList.add('success');
        statusText.textContent = 'Upload concluído!';
        statusText.style.display = 'block';
        statusText.classList.add('text-success');
        fileInfo.status = 'success';
      } else {
        throw new Error(result.error || 'Erro no upload');
      }
      
    } catch (error) {
      console.error('Upload error:', error);
      element.classList.remove('uploading');
      element.classList.add('error');
      statusText.textContent = 'Erro: ' + error.message;
      statusText.style.display = 'block';
      statusText.classList.add('text-danger');
      fileInfo.status = 'error';
    }
  }
  
  clearQueue() {
    this.fileQueue = [];
    const queueContainer = this.container.querySelector('.file-queue');
    queueContainer.innerHTML = '';
  }
}

// ===== GLOBAL FUNCTIONS =====

// Carregar anotações
window.carregarAnotacoes = function(contratoId) {
  console.log('🔄 Carregando anotações para contrato:', contratoId);
  
  fetch(`/contratos/${contratoId}/anotacoes`, {
    credentials: 'same-origin'
  })
  .then(response => {
    console.log('📡 Resposta carregamento:', response.status, response.statusText);
    return response.json();
  })
  .then(data => {
    console.log('📦 Dados recebidos:', data);
    const lista = document.getElementById('listaAnotacoes');
    if (!lista) {
      console.error('❌ Elemento listaAnotacoes não encontrado');
      return;
    }
    
    if (data.success && data.anotacoes && data.anotacoes.length > 0) {
      lista.innerHTML = data.anotacoes.map(anotacao => `
        <div class="border rounded p-3 mb-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <strong>Anotação #${anotacao.id}</strong>
            <button class="btn btn-sm btn-outline-danger" onclick="excluirAnotacao(${anotacao.id}, ${contratoId})">
              <i class="bi bi-trash"></i> Excluir
            </button>
          </div>
          <p class="mb-2">${anotacao.texto}</p>
          <small class="text-muted">
            Criada em: ${fmtData(anotacao.data_criacao)}
            ${anotacao.data_atualizacao && anotacao.data_atualizacao !== anotacao.data_criacao 
              ? '| Atualizada em: ' + fmtData(anotacao.data_atualizacao) 
              : ''}
          </small>
        </div>
      `).join('');
      console.log(`✅ ${data.anotacoes.length} anotações carregadas`);
    } else {
      lista.innerHTML = '<p class="text-muted">Nenhuma anotação encontrada.</p>';
      console.log('ℹ️ Nenhuma anotação encontrada');
    }
    
    // Carregar anexos após carregar anotações
    window.carregarAnexos(contratoId);
  })
  .catch(error => {
    console.error('❌ Erro ao carregar anotações:', error);
    const lista = document.getElementById('listaAnotacoes');
    if (lista) {
      lista.innerHTML = '<p class="text-danger">Erro ao carregar anotações.</p>';
    }
  });
};

// Carregar anexos
window.carregarAnexos = function(contratoId) {
  console.log('📎 Carregando anexos para contrato:', contratoId);
  
  fetch(`/contratos/${contratoId}/anexos`, {
    method: 'GET',
    credentials: 'same-origin'
  })
  .then(response => {
    console.log('📡 Resposta anexos:', response.status, response.statusText);
    return response.json();
  })
  .then(data => {
    console.log('📦 Anexos recebidos:', data);
    
    const tbody = document.getElementById('anexosBody');
    if (!tbody) {
      console.error('❌ Elemento anexosBody não encontrado');
      return;
    }
    
    if (!data.success) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">${data.error || 'Erro ao carregar anexos'}</td></tr>`;
      return;
    }
    
    if (!data.anexos || data.anexos.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Nenhum anexo encontrado</td></tr>';
      return;
    }
    
    const baseUrl = window.location.protocol + '//' + window.location.host;
    tbody.innerHTML = data.anexos.map(a => {
      const nome = a.nome_arquivo || 'Arquivo sem nome';
      const tamanho = a.tamanho_arquivo ? (a.tamanho_arquivo / 1024).toFixed(1) + ' KB' : 'N/A';
      const tipo = a.tipo_arquivo || 'N/A';
      const data_upload = fmtData(a.data_upload);
      
      const isImg = tipo.startsWith('image/');
      const isPdf = tipo === 'application/pdf';
      
      return `
        <tr>
          <td><i class="bi ${isPdf ? 'bi-file-earmark-pdf text-danger' : isImg ? 'bi-image text-success' : 'bi-file-earmark text-secondary'} me-2"></i>${nome}</td>
          <td>${tamanho}</td>
          <td><span class="badge bg-light text-dark">${tipo}</span></td>
          <td>${data_upload}</td>
          <td>
            ${isPdf ? `<button class="btn btn-sm btn-outline-primary" onclick="visualizarPDF(${a.id}, '${nome}')"><i class="bi bi-eye"></i></button>` : ''}
            ${isImg ? `<button class="btn btn-sm btn-outline-primary" onclick="verImagem('${baseUrl}/contratos/anexos/${a.id}/inline')"><i class="bi bi-eye"></i></button>` : ''}
            <a class="btn btn-sm btn-outline-secondary" target="_blank" href="${baseUrl}/contratos/anexos/${a.id}"><i class="bi bi-download"></i></a>
            <button class="btn btn-sm btn-outline-danger" onclick="excluirAnexo(${a.id}, ${contratoId})"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
    }).join('');
    console.log(`✅ ${data.anexos.length} anexos carregados`);
  })
  .catch(err => {
    console.error('❌ Erro ao carregar anexos:', err);
    const tbody = document.getElementById('anexosBody');
    if (tbody) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Erro ao carregar anexos: ${err.message}</td></tr>`;
    }
  });
};

// Visualizar imagem
window.verImagem = function(url) {
  const img = document.getElementById('imgPreview');
  img.src = url;
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalImg')).show();
};

// Visualizar PDF
window.visualizarPDF = function(anexoId, nomeArquivo) {
  console.log('📄 Abrindo PDF:', anexoId, nomeArquivo);
  
  // Primeiro tenta abrir em nova aba (mais compatível)
  const novaAba = window.open(`/contratos/anexos/${anexoId}/inline`, '_blank');
  
  if (novaAba) {
    console.log('✅ PDF aberto em nova aba');
    return;
  }
  
  // Se não conseguir abrir nova aba, usa modal
  const modalHTML = `
    <div class="modal fade" id="modalVisualizarPDF" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="bi bi-file-earmark-pdf me-2"></i>Visualizar PDF: ${nomeArquivo}
            </h5>
            <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <div class="modal-body p-2" style="height: 70vh;">
            <iframe src="/contratos/anexos/${anexoId}/inline" 
                    width="100%" 
                    height="100%" 
                    frameborder="0"
                    style="border: 1px solid #ddd; border-radius: 0.375rem;">
              <div class="alert alert-warning text-center">
                <i class="bi bi-exclamation-triangle me-2"></i>
                Seu navegador não suporta visualização de PDFs. 
                <a href="/contratos/anexos/${anexoId}" target="_blank" class="alert-link">Clique aqui para baixar</a>
              </div>
            </iframe>
          </div>
          <div class="modal-footer">
            <a href="/contratos/anexos/${anexoId}" target="_blank" rel="noopener" class="btn btn-outline-primary">
              <i class="bi bi-download me-1"></i>Baixar PDF
            </a>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-circle me-1"></i>Fechar
            </button>
          </div>
        </div>
      </div>
    </div>`;
  
  // Remove modal anterior se existir
  const modalExistente = document.getElementById('modalVisualizarPDF');
  if (modalExistente) {
    modalExistente.remove();
  }
  
  // Adiciona novo modal ao body
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Abre o modal
  const modalElement = document.getElementById('modalVisualizarPDF');
  const modal = new bootstrap.Modal(modalElement);
  modal.show();
  
  // Remove modal quando fechado para não acumular
  modalElement.addEventListener('hidden.bs.modal', function () {
    this.remove();
  });
};

// Excluir anexo
window.excluirAnexo = function(anexoId, contratoId) {
  if (!confirm('Excluir este anexo?')) return;
  
  console.log('🗑️ Excluindo anexo:', anexoId);
  const baseUrl = window.location.protocol + '//' + window.location.host;
  
  fetch(`${baseUrl}/contratos/anexos/${anexoId}`, {
    method: 'DELETE',
    credentials: 'same-origin'
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      console.log('✅ Anexo excluído');
      carregarAnexos(contratoId);
    } else {
      alert(d.error || 'Erro ao excluir');
    }
  })
  .catch(() => alert('Erro ao excluir'));
};

// Excluir anotação
window.excluirAnotacao = function(anotacaoId, contratoId) {
  if (!confirm('Tem certeza que deseja excluir esta anotação? Esta ação não pode ser desfeita.')) return;
  
  console.log('🗑️ Excluindo anotação:', anotacaoId, 'do contrato:', contratoId);
  
  fetch(`/contratos/anotacoes/${anotacaoId}`, { 
    method: 'DELETE', 
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(r => {
    console.log('📡 Resposta exclusão:', r.status, r.statusText);
    return r.json();
  })
  .then(data => {
    console.log('📦 Dados exclusão:', data);
    if (!data.success) {
      alert('Erro ao excluir: ' + (data.error || 'Falha desconhecida'));
      return;
    }
    console.log('✅ Anotação excluída! Recarregando lista...');
    window.carregarAnotacoes(contratoId);
  })
  .catch(err => {
    console.error('❌ Erro na exclusão:', err);
    alert('Erro ao excluir anotação: ' + err.message);
  });
};

// Feedback visual nos botões
function mostrarFeedback(btn, sucesso = true, label = 'Salvando...') {
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${label}`;
  
  setTimeout(() => {
    if (sucesso) {
      btn.classList.add('btn-feedback-success');
      btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Sucesso!';
    } else {
      btn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Erro';
    }
    
    setTimeout(() => {
      btn.disabled = false;
      btn.classList.remove('btn-feedback-success');
      btn.innerHTML = originalHTML;
    }, 2000);
  }, 1000);
}

// Salvar anotação (com anexos)
window.salvarAnotacao = function() {
  console.log('💾 Salvando anotação com anexos...');
  
  const contratoId = document.getElementById('contratoIdAnotacao').value;
  const texto = document.getElementById('anotacaoTexto').value.trim();
  const btn = document.getElementById('btnSalvarAnotacao');
  
  if (!texto) {
    document.getElementById('anotacaoTexto').classList.add('is-invalid');
    setTimeout(() => document.getElementById('anotacaoTexto').classList.remove('is-invalid'), 3000);
    return;
  }
  
  mostrarFeedback(btn, true, 'Salvando...');
  
  // Primeiro salva o texto
  const formData = new FormData();
  formData.append('texto', texto);
  
  fetch(`/contratos/${contratoId}/anotacoes`, {
    method: 'POST',
    body: formData,
    credentials: 'same-origin'
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) {
      mostrarFeedback(btn, false);
      alert('Erro: ' + (data.error || 'Falha ao salvar'));
      return;
    }
    
    console.log('✅ Anotação salva! Enviando anexos...');
    
    // Se há anexos, envia-os
    const uploader = window.uploaderInstance;
    if (uploader && uploader.fileQueue.length > 0) {
      uploader.uploadFiles().then(() => {
        document.getElementById('formNovaAnotacao').reset();
        uploader.clearQueue();
        window.carregarAnotacoes(contratoId);
      });
    } else {
      document.getElementById('formNovaAnotacao').reset();
      window.carregarAnotacoes(contratoId);
    }
  })
  .catch(err => {
    console.error('❌ Erro:', err);
    mostrarFeedback(btn, false);
    alert('Erro: ' + err.message);
  });
};

// Salvar só texto
window.salvarSoTexto = function() {
  console.log('💾 Salvando apenas texto...');
  
  const contratoId = document.getElementById('contratoIdAnotacao').value;
  const texto = document.getElementById('anotacaoTexto').value.trim();
  const btn = document.getElementById('btnSalvarSoTexto');
  
  if (!texto) {
    document.getElementById('anotacaoTexto').classList.add('is-invalid');
    setTimeout(() => document.getElementById('anotacaoTexto').classList.remove('is-invalid'), 3000);
    return;
  }
  
  mostrarFeedback(btn, true, 'Salvando...');
  
  const formData = new FormData();
  formData.append('texto', texto);
  
  fetch(`/contratos/${contratoId}/anotacoes`, {
    method: 'POST',
    body: formData,
    credentials: 'same-origin'
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) {
      mostrarFeedback(btn, false);
      alert('Erro: ' + (data.error || 'Falha ao salvar'));
      return;
    }
    
    console.log('✅ Texto salvo!');
    document.getElementById('formNovaAnotacao').reset();
    window.carregarAnotacoes(contratoId);
  })
  .catch(err => {
    console.error('❌ Erro:', err);
    mostrarFeedback(btn, false);
    alert('Erro: ' + err.message);
  });
};

// Abrir modal de anotações
window.abrirModalAnotacoes = function(contratoId, numeroContrato) {
  console.log('[MODAL] Abrindo modal para contrato:', contratoId, numeroContrato);
  
  const modalEl = document.getElementById('modalAnotacoes');
  if (!modalEl) {
    console.error('[MODAL] Modal não encontrado');
    return;
  }
  
  // Configurar dados do modal
  document.getElementById('contratoIdAnotacao').value = contratoId;
  const labelEl = document.getElementById('modalAnotacoesLabel');
  if (labelEl) {
    labelEl.innerHTML = `<i class="bi bi-journal-text me-2"></i>Anotações - Contrato ${numeroContrato}`;
  }
  
  // Reset do formulário
  document.getElementById('formNovaAnotacao').reset();
  
  // Inicializar uploader
  window.uploaderInstance = new ProfessionalUploader('uploaderContainer', contratoId);
  
  // Abrir modal e carregar dados
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
  
  window.carregarAnotacoes(contratoId);
};

// Other utility functions
window.gerarRelatorioContrato = function(contratoId) {
  window.open(`/contratos/${contratoId}/relatorio`, '_blank');
};

window.confirmarExclusao = function(url) {
  if (confirm('Tem certeza que deseja excluir este contrato? Esta ação não pode ser desfeita.')) {
    window.location.href = url;
  }
};

</script>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 text-gray-800"><i class="bi bi-file-earmark-text me-2" aria-hidden="true"></i>Gestão de Contratos</h1>
    <p class="text-muted mb-0">Gerencie todos os contratos da instituição</p>
  </div>
  <div>
    <a href="{{ url_for('contratos.novo') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-1" aria-hidden="true"></i> Novo Contrato
    </a>
  </div>
</div>

<!-- Cards de Estatísticas -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total de Contratos</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ total_contratos if total_contratos is defined else (contratos|length if contratos else 0) }}
            </div>
          </div>
          <div class="col-auto"><i class="bi bi-file-earmark-text fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Contratos Ativos</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ total_ativos if total_ativos is defined else (contratos|selectattr('status','equalto','ATIVO')|list|length if contratos else 0) }}
            </div>
          </div>
          <div class="col-auto"><i class="bi bi-check-circle fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Vencendo em 30 dias</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ vencendo_30 if vencendo_30 is defined else 0 }}</div>
          </div>
          <div class="col-auto"><i class="bi bi-exclamation-triangle fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Valor Total Ativo</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              R$ {{ ('%.2f'|format((valor_total_ativo if valor_total_ativo is defined else 0)|float))|replace('.', ',') }}
            </div>
          </div>
          <div class="col-auto"><i class="bi bi-currency-dollar fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-funnel me-2" aria-hidden="true"></i>Filtros de Pesquisa</h6>
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-lg-3 col-md-6">
        <label for="empresaFilter" class="form-label">Empresa</label>
        <input type="text" class="form-control" id="empresaFilter" placeholder="Nome da empresa...">
      </div>
      <div class="col-lg-3 col-md-6">
        <label for="statusFilter" class="form-label">Status</label>
        <select class="form-select" id="statusFilter">
          <option value="">Todos os status</option>
          <option value="ATIVO">Ativo</option>
          <option value="INATIVO">Inativo</option>
          <option value="SUSPENSO">Suspenso</option>
          <option value="FINALIZADO">Finalizado</option>
        </select>
      </div>
      <div class="col-lg-2 col-md-6">
        <label for="dataInicioFilter" class="form-label">Data Início</label>
        <input type="date" class="form-control" id="dataInicioFilter">
      </div>
      <div class="col-lg-2 col-md-6">
        <label for="dataFimFilter" class="form-label">Data Fim</label>
        <input type="date" class="form-control" id="dataFimFilter">
      </div>
      <div class="col-lg-2 col-md-12">
        <button type="button" class="btn btn-outline-secondary w-100" id="limparFiltros">
          <i class="bi bi-arrow-clockwise me-1" aria-hidden="true"></i> Limpar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Tabela -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-table me-2" aria-hidden="true"></i>Lista de Contratos</h6>
  </div>
  <div class="card-body">
    {% if contratos %}
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="tabelaContratos">
        <thead class="table-light">
          <tr>
            <th>Empresa</th>
            <th>Número</th>
            <th>Objeto</th>
            <th>Valor</th>
            <th>Data Início</th>
            <th>Data Fim</th>
            <th>Status</th>
            <th width="170">Ações</th>
          </tr>
        </thead>
        <tbody>
        {% for contrato in contratos %}
          <tr>
            <td data-empresa="{{ (contrato.fornecedor or '') | lower }}">{{ contrato.fornecedor or 'N/A' }}</td>
            <td><span class="fw-semibold">{{ contrato.numero_contrato or 'N/A' }}</span></td>
            <td><div class="text-truncate-2" title="{{ contrato.objeto or 'N/A' }}">{{ contrato.objeto or 'N/A' }}</div></td>
            <td>
              <span class="fw-semibold text-success">
                R$
                {% if contrato.valor_total is not none %}
                  {{ "%.2f"|format(contrato.valor_total|float) | replace('.', ',') }}
                {% else %}
                  0,00
                {% endif %}
              </span>
            </td>
            <td data-data="{{ contrato.data_inicio.strftime('%Y-%m-%d') if contrato.data_inicio else '' }}">
              {{ contrato.data_inicio.strftime('%d/%m/%Y') if contrato.data_inicio else 'N/A' }}
            </td>
            <td data-data="{{ contrato.data_fim.strftime('%Y-%m-%d') if contrato.data_fim else '' }}">
              {{ contrato.data_fim.strftime('%d/%m/%Y') if contrato.data_fim else 'N/A' }}
            </td>
            <td data-status="{{ (contrato.status or '') | upper }}">
              {% if contrato.status == 'ATIVO' %}
                <span class="badge bg-success">Ativo</span>
              {% elif contrato.status == 'INATIVO' %}
                <span class="badge bg-secondary">Inativo</span>
              {% elif contrato.status == 'SUSPENSO' %}
                <span class="badge bg-warning text-dark">Suspenso</span>
              {% elif contrato.status == 'FINALIZADO' %}
                <span class="badge bg-info text-dark">Finalizado</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ contrato.status or 'N/A' }}</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group" aria-label="Ações do contrato {{ contrato.numero_contrato }}">
                <a href="{{ url_for('contratos.detalhes', id=contrato.id) }}" class="btn btn-outline-info btn-action" title="Visualizar Detalhes">
                  <i class="bi bi-eye" aria-hidden="true"></i><span class="visually-hidden">Detalhes</span>
                </a>
                <a href="{{ url_for('contratos_wtf.editar', id=contrato.id) }}" class="btn btn-outline-primary btn-action" title="Editar Contrato">
                  <i class="bi bi-pencil" aria-hidden="true"></i><span class="visually-hidden">Editar</span>
                </a>
                <button type="button" class="btn btn-outline-warning btn-action"
                        onclick='abrirModalAnotacoes({{ contrato.id }}, {{ contrato.numero_contrato|tojson }})'
                        title="Anotações e Anexos">
                  <i class="bi bi-journal-text" aria-hidden="true"></i><span class="visually-hidden">Anotações</span>
                </button>
                <a href="{{ url_for('contratos.novo_aditivo', contrato_id=contrato.id) }}" class="btn btn-outline-success btn-action" title="Adicionar Aditivo">
                  <i class="bi bi-plus-circle" aria-hidden="true"></i><span class="visually-hidden">Aditivo</span>
                </a>
                <button type="button" class="btn btn-outline-secondary btn-action"
                        onclick="gerarRelatorioContrato({{ contrato.id }})"
                        title="Gerar Relatório">
                  <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i><span class="visually-hidden">Relatório</span>
                </button>
                <button type="button" class="btn btn-outline-danger btn-action"
                        onclick="confirmarExclusao('{{ url_for('contratos.excluir', id=contrato.id) }}')"
                        title="Excluir Contrato">
                  <i class="bi bi-trash" aria-hidden="true"></i><span class="visually-hidden">Excluir</span>
                </button>
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-file-earmark-text fa-3x text-muted mb-3" aria-hidden="true"></i>
      <h5 class="text-muted">Nenhum contrato encontrado</h5>
      <p class="text-muted">Comece criando um novo contrato.</p>
      <a href="{{ url_for('contratos.novo') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1" aria-hidden="true"></i> Criar Primeiro Contrato
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal de Anotações -->
<div class="modal fade" id="modalAnotacoes" tabindex="-1" aria-labelledby="modalAnotacoesLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAnotacoesLabel">
          <i class="bi bi-journal-text me-2"></i>Anotações - Contrato
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Coluna Esquerda - Nova Anotação -->
          <div class="col-lg-6">
            <h6 class="fw-bold mb-3">
              <i class="bi bi-plus-circle me-2 text-primary"></i>Nova Anotação
            </h6>
            
            <form id="formNovaAnotacao">
              <input type="hidden" id="contratoIdAnotacao" name="contrato_id">
              
              <!-- Campo de texto -->
              <div class="mb-3">
                <label for="anotacaoTexto" class="form-label">Texto da Anotação *</label>
                <textarea class="form-control" id="anotacaoTexto" name="texto" rows="4" 
                          placeholder="Digite sua anotação aqui..." required></textarea>
              </div>
              
              <!-- Professional Uploader -->
              <div id="uploaderContainer">
                <div class="mb-3">
                  <label class="form-label">Anexos (Opcional)</label>
                  
                  <!-- Dropzone -->
                  <div class="dropzone text-center p-4 mb-3">
                    <div class="mb-2">
                      <i class="bi bi-cloud-upload fs-1 text-muted"></i>
                    </div>
                    <p class="mb-2 fw-semibold">Arraste e solte arquivos aqui</p>
                    <p class="text-muted small mb-3">ou clique para selecionar</p>
                    <input type="file" id="anexos" name="anexos" multiple 
                           accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx" 
                           class="form-control" style="display: none;">
                    <button type="button" class="btn btn-outline-primary btn-sm" 
                            onclick="document.getElementById('anexos').click()">
                      <i class="bi bi-folder2-open me-1"></i>Selecionar Arquivos
                    </button>
                  </div>
                  
                  <!-- File Queue -->
                  <div class="file-queue"></div>
                </div>
              </div>
              
              <!-- Botões de ação -->
              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" id="btnSalvarAnotacao">
                  <i class="bi bi-cloud-upload me-1"></i>Salvar com Anexos
                </button>
                <button type="button" class="btn btn-outline-secondary" id="btnSalvarSoTexto">
                  <i class="bi bi-file-text me-1"></i>Salvar Só Texto
                </button>
              </div>
            </form>
          </div>
          
          <!-- Coluna Direita - Anotações Existentes -->
          <div class="col-lg-6">
            <h6 class="fw-bold mb-3">
              <i class="bi bi-list-ul me-2 text-success"></i>Anotações Existentes
            </h6>
            <div id="listaAnotacoes" style="max-height: 400px; overflow-y: auto;">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando anotações...</p>
              </div>
            </div>
            
            <!-- Tabela de Anexos -->
            <h6 class="fw-bold mb-3 mt-4">
              <i class="bi bi-paperclip me-2 text-warning"></i>Anexos
            </h6>
            <div style="max-height: 300px; overflow-y: auto;">
              <table class="table table-sm table-striped">
                <thead>
                  <tr>
                    <th>Arquivo</th>
                    <th>Tamanho</th>
                    <th>Tipo</th>
                    <th>Data</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="anexosBody">
                  <tr>
                    <td colspan="5" class="text-center text-muted">Carregando anexos...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para visualizar imagens -->
<div class="modal fade" id="modalImg" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Visualizar Imagem</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="imgPreview" src="" class="img-fluid" alt="Preview">
      </div>
    </div>
  </div>
</div>

<script>
// ===== FILTROS CLIENT-SIDE =====
(function () {
  const empresaInput = document.getElementById('empresaFilter');
  const statusSel = document.getElementById('statusFilter');
  const dtIni = document.getElementById('dataInicioFilter');
  const dtFim = document.getElementById('dataFimFilter');
  const btnLimpar = document.getElementById('limparFiltros');
  const tbody = document.querySelector('#tabelaContratos tbody');

  if (!tbody) return;

  const debounce = (fn, ms=200) => { 
    let t; 
    return (...a) => { 
      clearTimeout(t); 
      t = setTimeout(() => fn(...a), ms); 
    }; 
  };

  function aplicaFiltros() {
    const emp = (empresaInput?.value || '').trim().toLowerCase();
    const st = (statusSel?.value || '').trim().toUpperCase();
    const di = dtIni?.value ? new Date(dtIni.value) : null;
    const df = dtFim?.value ? new Date(dtFim.value) : null;

    [...tbody.rows].forEach(tr => {
      const tdEmpresa = tr.querySelector('td[data-empresa]');
      const tdStatus = tr.querySelector('td[data-status]');
      const cols = tr.querySelectorAll('td[data-data]');
      const tdIni = cols[0];
      const tdFim = cols[1];

      const matchEmpresa = emp === '' || (tdEmpresa?.dataset.empresa || '').includes(emp);
      const matchStatus = st === '' || (tdStatus?.dataset.status || '') === st;

      const vIni = tdIni?.dataset.data ? new Date(tdIni.dataset.data) : null;
      const vFim = tdFim?.dataset.data ? new Date(tdFim.dataset.data) : null;

      let matchPeriodo = true;
      if (di && vIni) matchPeriodo = vIni >= di;
      if (matchPeriodo && df && vFim) matchPeriodo = vFim <= df;

      tr.style.display = (matchEmpresa && matchStatus && matchPeriodo) ? '' : 'none';
    });
  }

  empresaInput?.addEventListener('input', debounce(aplicaFiltros));
  statusSel?.addEventListener('change', aplicaFiltros);
  dtIni?.addEventListener('change', aplicaFiltros);
  dtFim?.addEventListener('change', aplicaFiltros);

  btnLimpar?.addEventListener('click', () => {
    if (empresaInput) empresaInput.value = '';
    if (statusSel) statusSel.value = '';
    if (dtIni) dtIni.value = '';
    if (dtFim) dtFim.value = '';
    aplicaFiltros();
  });

  aplicaFiltros();
})();
</script>

{% endblock %}

{% extends "base.html" %}

{% block title %}Gest√£o de Contratos{% endblock %}
{% block page_title %}Contratos{% endblock %}

{% block extra_css %}
<style>
/* Bot√µes de a√ß√£o */
.btn-action { min-width: 40px; border-radius: 6px; transition: all 0.2s ease; }
.btn-action:hover { transform: translateY(-1px); box-shadow: 0 2px 8px rgba(0,0,0,0.15); }

/* Dropdown de a√ß√µes */
.dropdown-menu { border: 1px solid #e3e6f0; box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,.15); border-radius: .35rem; }
.dropdown-item { padding: .5rem 1rem; transition: all .2s ease; }
.dropdown-item:hover { background-color: #f8f9fc; transform: translateX(3px); }
.dropdown-item.text-danger:hover { background-color: #f8d7da; color: #721c24 !important; }

/* Tabela */
.table th { border-top: none; background-color: #f8f9fc; font-weight: 600; color: #5a5c69; font-size: .85rem; text-transform: uppercase; letter-spacing: .5px; }
.table td { vertical-align: middle; padding: 1rem .75rem; }

/* Badge status */
.badge { font-size: .75rem; padding: .35rem .65rem; border-radius: .25rem; }

/* Truncar texto longo do objeto (2 linhas) */
.text-truncate-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; max-width: 320px; }

/* Hover dos cards */
.card { transition: all 0.2s ease; }
.card:hover { transform: translateY(-2px); box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); }

/* Modal de anota√ß√µes */
.modal-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.modal-body { max-height: 60vh; overflow-y: auto; }
.anotacao-item { border-left: 3px solid #667eea; background: #f8f9fc; padding: 1rem; margin-bottom: 0.5rem; border-radius: 0.25rem; }

/* Valida√ß√£o elegante */
.is-invalid { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important; animation: shake 0.5s ease-in-out; }

/* Anexos das anota√ß√µes */
.anexos-anotacao { background: #f8f9fa; border-radius: 0.375rem; padding: 0.75rem; margin-top: 0.5rem; }
.anexos-anotacao h6 { color: #495057; margin-bottom: 0.5rem; }
.anexo-item { background: white; border: 1px solid #dee2e6; border-radius: 0.375rem; transition: all 0.2s ease; }
.anexo-item:hover { border-color: #667eea; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1); }
.btn-group-sm .btn { padding: 0.25rem 0.5rem; font-size: 0.75rem; }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* Feedback de sucesso */
.btn-feedback-success { 
  background-color: #28a745 !important; 
  border-color: #28a745 !important; 
  color: white !important;
  transition: all 0.3s ease;
}

/* Anexos - Cards de arquivo */
.anexo-card {
  transition: all 0.2s ease;
  border: 1px solid #e3e6f0;
}

.anexo-card:hover {
  border-color: #667eea;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Modal PDF */
#modalVisualizarPDF .modal-dialog {
  max-width: 95vw;
}

#modalVisualizarPDF iframe {
  border-radius: 0.375rem;
}

/* Professional Drag & Drop Uploader */
.dropzone { 
  border: 2px dashed #dee2e6; 
  border-radius: 10px; 
  transition: all 0.3s ease; 
  min-height: 120px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.dropzone.dragover { 
  border-color: #007bff; 
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  transform: scale(1.02);
}

.upload-progress { 
  height: 4px; 
  overflow: hidden; 
  border-radius: 2px; 
  background-color: #f8f9fa;
}

.file-queue-item {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 8px;
  transition: all 0.3s ease;
}

.file-queue-item.uploading {
  border-color: #007bff;
  background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
}

.file-queue-item.success {
  border-color: #28a745;
  background: linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%);
}

.file-queue-item.error {
  border-color: #dc3545;
  background: linear-gradient(135deg, #f8d7da 0%, #f8f9fa 100%);
}

.file-preview-icon {
  width: 40px;
  height: 40px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
}

.icon-pdf { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; }
.icon-image { background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white; }
.icon-word { background: linear-gradient(135deg, #2b5797 0%, #1e3d72 100%); color: white; }
.icon-excel { background: linear-gradient(135deg, #1d7044 0%, #155724 100%); color: white; }
.icon-default { background: linear-gradient(135deg, #6c757d 0%, #545b62 100%); color: white; }
</style>
{% endblock %}

{% block content %}

<script>
// ===== UTILITY FUNCTIONS =====

// Compatibility fix for crypto.randomUUID
function generateUUID() {
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return crypto.randomUUID();
  }
  // Fallback implementation
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// Formata√ß√£o de data melhorada
function fmtData(v) {
  if (!v) return 'N/A';
  // ISO 8601 ou timestamp
  if (/^\d{4}-\d{2}-\d{2}/.test(v) || !isNaN(v)) {
    const d = new Date(v);
    return isNaN(d) ? 'Data inv√°lida' :
      d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
  }
  // DD/MM/YYYY [HH:mm]
  const m = String(v).match(/^(\d{2})\/(\d{2})\/(\d{4})(?:[ T](\d{2}):(\d{2}))?/);
  if (m) {
    const [, dd, mm, yyyy, HH='00', MM='00'] = m;
    const d = new Date(+yyyy, +mm - 1, +dd, +HH, +MM);
    return isNaN(d) ? 'Data inv√°lida' :
      d.toLocaleString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });
  }
  return 'Data inv√°lida';
}

// ===== FILE UPLOAD SYSTEM =====

class ProfessionalUploader {
  constructor(containerId, contratoId) {
    this.container = document.getElementById(containerId);
    this.contratoId = contratoId;
    this.fileQueue = [];
    this.fileInput = null;          // << novo
    this._boundOpenPicker = null;   // << novo
    this.init();
  }
  
  init() {
    this.setupFileInput();
    this.setupDropzone();
  }
  
  setupDropzone() {
    const dropzone = this.container.querySelector('.dropzone');

    // prevenir comportamento padr√£o do drag
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt =>
      dropzone.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }, false)
    );

    ['dragenter', 'dragover'].forEach(evt =>
      dropzone.addEventListener(evt, () => dropzone.classList.add('dragover'), false)
    );
    ['dragleave', 'drop'].forEach(evt =>
      dropzone.addEventListener(evt, () => dropzone.classList.remove('dragover'), false)
    );

    // soltar arquivos
    dropzone.addEventListener('drop', (e) => {
      const files = e.dataTransfer?.files || [];
      this.handleFiles(files);
    }, false);

    // abrir seletor ao clicar em qualquer ponto da dropzone
    dropzone.addEventListener('click', (e) => {
      // se clicou no bot√£o, deixa o handler abaixo cuidar
      if (e.target.closest('[data-open-picker]')) return;
      if (this.fileInput) {
        this.fileInput.value = ''; // permite escolher o mesmo arquivo de novo
        this.fileInput.click();
      }
    }, false);

    // bot√£o "clique para selecionar"
    const btn = this.container.querySelector('[data-open-picker]');
    if (btn) btn.addEventListener('click', (e) => {
      e.preventDefault(); e.stopPropagation();
      if (this.fileInput) {
        this.fileInput.value = '';
        this.fileInput.click();
      }
    }, false);
  }
  
  setupFileInput() {
    this.fileInput = this.container.querySelector('#anexos');
    this.fileInput.addEventListener('change', (e) => {
      this.handleFiles(e.target.files);
      // permite escolher o MESMO arquivo novamente no pr√≥ximo clique
      this.fileInput.value = '';
    });
  }
  
  handleFiles(files) {
    [...files].forEach(file => this.addToQueue(file));
  }
  
  addToQueue(file) {
    const fileId = generateUUID();
    const fileInfo = {
      id: fileId,
      file: file,
      name: file.name,
      size: file.size,
      type: file.type,
      status: 'pending'
    };
    
    this.fileQueue.push(fileInfo);
    this.renderQueueItem(fileInfo);
  }
  
  renderQueueItem(fileInfo) {
    const queueContainer = this.container.querySelector('.file-queue');
    const icon = this.getFileIcon(fileInfo.type);
    
    const html = `
      <div class="file-queue-item" data-file-id="${fileInfo.id}">
        <div class="d-flex align-items-center">
          <div class="file-preview-icon ${icon.class} me-3">
            <i class="bi ${icon.icon}"></i>
          </div>
          <div class="flex-grow-1">
            <div class="fw-semibold">${fileInfo.name}</div>
            <small class="text-muted">${this.formatFileSize(fileInfo.size)}</small>
            <div class="upload-progress mt-1" style="display: none;">
              <div class="progress-bar bg-primary" style="width: 0%"></div>
            </div>
            <div class="status-text mt-1" style="display: none;"></div>
          </div>
          <div class="file-actions">
            <button class="btn btn-sm btn-outline-danger remove-file" data-file-id="${fileInfo.id}">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
      </div>`;
    
    queueContainer.insertAdjacentHTML('beforeend', html);
    
    // Add remove handler
    const removeBtn = queueContainer.querySelector(`[data-file-id="${fileInfo.id}"] .remove-file`);
    removeBtn.addEventListener('click', () => this.removeFromQueue(fileInfo.id));
  }
  
  getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return { class: 'icon-image', icon: 'bi-image' };
    if (mimeType === 'application/pdf') return { class: 'icon-pdf', icon: 'bi-file-earmark-pdf' };
    if (mimeType.includes('word')) return { class: 'icon-word', icon: 'bi-file-earmark-word' };
    if (mimeType.includes('excel') || mimeType.includes('spreadsheet')) return { class: 'icon-excel', icon: 'bi-file-earmark-excel' };
    return { class: 'icon-default', icon: 'bi-file-earmark' };
  }
  
  formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }
  
  removeFromQueue(fileId) {
    this.fileQueue = this.fileQueue.filter(f => f.id !== fileId);
    const element = this.container.querySelector(`[data-file-id="${fileId}"]`);
    if (element) element.remove();
  }
  
  async uploadFiles() {
    const pendingFiles = this.fileQueue.filter(f => f.status === 'pending');
    
    for (const fileInfo of pendingFiles) {
      await this.uploadSingleFile(fileInfo);
    }
  }
  
  async uploadSingleFile(fileInfo) {
    const element = this.container.querySelector(`[data-file-id="${fileInfo.id}"]`);
    const progressBar = element.querySelector('.progress-bar');
    const statusText = element.querySelector('.status-text');
    const progressContainer = element.querySelector('.upload-progress');
    
    // Show progress
    progressContainer.style.display = 'block';
    element.classList.add('uploading');
    fileInfo.status = 'uploading';
    
    const formData = new FormData();
    formData.append('arquivo', fileInfo.file);
    
    try {
      const xhr = new XMLHttpRequest();
      
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const percentComplete = (e.loaded / e.total) * 100;
          progressBar.style.width = percentComplete + '%';
        }
      });
      
      const response = await new Promise((resolve, reject) => {
        xhr.onload = () => resolve(xhr);
        xhr.onerror = () => reject(new Error('Erro na requisi√ß√£o'));
        xhr.open('POST', `/contratos/${this.contratoId}/anexos`);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        
        // CSRF token support
        const token = document.querySelector('meta[name="csrf-token"]')?.content;
        if (token) xhr.setRequestHeader('X-CSRFToken', token);
        xhr.send(formData);
      });
      
      const result = JSON.parse(response.responseText);
      
      if (result.success) {
        element.classList.remove('uploading');
        element.classList.add('success');
        statusText.textContent = 'Upload conclu√≠do!';
        statusText.style.display = 'block';
        statusText.classList.add('text-success');
        fileInfo.status = 'success';
      } else {
        throw new Error(result.error || 'Erro no upload');
      }
      
    } catch (error) {
      console.error('Upload error:', error);
      element.classList.remove('uploading');
      element.classList.add('error');
      statusText.textContent = 'Erro: ' + error.message;
      statusText.style.display = 'block';
      statusText.classList.add('text-danger');
      fileInfo.status = 'error';
    }
  }
  
  clearQueue() {
    this.fileQueue = [];
    const queueContainer = this.container.querySelector('.file-queue');
    queueContainer.innerHTML = '';
  }
}

// Make ProfessionalUploader globally available
window.ProfessionalUploader = ProfessionalUploader;

// ===== GLOBAL FUNCTIONS =====

// Carregar anota√ß√µes
window.carregarAnotacoes = function(contratoId) {
  console.log('üîÑ Carregando anota√ß√µes para contrato:', contratoId);
  
  fetch(`/contratos/${contratoId}/anotacoes`, {
    credentials: 'same-origin'
  })
  .then(response => {
    console.log('üì° Resposta carregamento:', response.status, response.statusText);
    return response.json();
  })
  .then(data => {
    console.log('üì¶ Dados recebidos:', data);
    const lista = document.getElementById('listaAnotacoes');
    if (!lista) {
      console.error('‚ùå Elemento listaAnotacoes n√£o encontrado');
      return;
    }
    
    if (data.success && data.anotacoes && data.anotacoes.length > 0) {
      lista.innerHTML = data.anotacoes.map(anotacao => `
        <div class="border rounded p-3 mb-3">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <strong>Anota√ß√£o #${anotacao.id}</strong>
            <button class="btn btn-sm btn-outline-danger" onclick="excluirAnotacao(${anotacao.id}, ${contratoId})">
              <i class="bi bi-trash"></i> Excluir
            </button>
          </div>
          <p class="mb-2">${anotacao.texto}</p>
          
          <!-- ANEXOS DA ANOTA√á√ÉO -->
          ${anotacao.anexos && anotacao.anexos.length > 0 ? `
            <div class="anexos-anotacao mt-3">
              <h6 class="mb-2"><i class="bi bi-paperclip"></i> Anexos (${anotacao.anexos.length})</h6>
              <div class="row">
                ${anotacao.anexos.map(anexo => `
                  <div class="col-md-6 mb-2">
                    <div class="anexo-item p-2 d-flex align-items-center justify-content-between">
                      <div class="d-flex align-items-center">
                        <i class="bi ${getFileIcon(anexo.tipo)} me-2"></i>
                        <div>
                          <div class="fw-bold">${anexo.nome}</div>
                          <small class="text-muted">${formatFileSize(anexo.tamanho)} ‚Ä¢ ${anexo.tipo}</small>
                        </div>
                      </div>
                      <div class="btn-group btn-group-sm">
                        ${anexo.tipo === 'application/pdf' ? `
                          <button class="btn btn-outline-primary" onclick="visualizarPDF(${anexo.id}, '${anexo.nome}')" title="Visualizar PDF">
                            <i class="bi bi-eye"></i>
                          </button>
                        ` : ''}
                        <button class="btn btn-outline-secondary" onclick="downloadAnexo(${anexo.id}, '${anexo.nome}')" title="Download">
                          <i class="bi bi-download"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="excluirAnexo(${anexo.id}, ${anotacao.id}, ${contratoId})" title="Excluir">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <small class="text-muted d-block mt-2">
            Criada em: ${fmtData(anotacao.data_criacao)}
            ${anotacao.data_atualizacao && anotacao.data_atualizacao !== anotacao.data_criacao 
              ? '| Atualizada em: ' + fmtData(anotacao.data_atualizacao) 
              : ''}
          </small>
        </div>
      `).join('');
      console.log(`‚úÖ ${data.anotacoes.length} anota√ß√µes carregadas`);
    } else {
      lista.innerHTML = '<p class="text-muted">Nenhuma anota√ß√£o encontrada.</p>';
      console.log('‚ÑπÔ∏è Nenhuma anota√ß√£o encontrada');
    }
    
    // Anexos s√£o exibidos junto com anota√ß√µes no novo design
    console.log('‚úÖ Anota√ß√µes carregadas (anexos integrados)');
  })
  .catch(error => {
    console.error('‚ùå Erro ao carregar anota√ß√µes:', error);
    const lista = document.getElementById('listaAnotacoes');
    if (lista) {
      lista.innerHTML = '<p class="text-danger">Erro ao carregar anota√ß√µes.</p>';
    }
  });
};

// Carregar anexos (descontinuada - anexos integrados com anota√ß√µes)
window.carregarAnexos = function(/* contratoId */) {
  console.log('üìé Fun√ß√£o carregarAnexos descontinuada - anexos integrados');
  return Promise.resolve();
};

// Visualizar imagem
window.verImagem = function(url) {
  const img = document.getElementById('imgPreview');
  img.src = url;
  bootstrap.Modal.getOrCreateInstance(document.getElementById('modalImg')).show();
};

// Excluir anota√ß√£o
window.excluirAnotacao = function(anotacaoId, contratoId) {
  if (!confirm('Tem certeza que deseja excluir esta anota√ß√£o? Esta a√ß√£o n√£o pode ser desfeita.')) return;
  
  console.log('üóëÔ∏è Excluindo anota√ß√£o:', anotacaoId, 'do contrato:', contratoId);
  
  fetch(`/contratos/anotacoes/${anotacaoId}`, { 
    method: 'DELETE', 
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(r => {
    console.log('üì° Resposta exclus√£o:', r.status, r.statusText);
    return r.json();
  })
  .then(data => {
    console.log('üì¶ Dados exclus√£o:', data);
    if (!data.success) {
      alert('Erro ao excluir: ' + (data.error || 'Falha desconhecida'));
      return;
    }
    console.log('‚úÖ Anota√ß√£o exclu√≠da! Recarregando lista...');
    window.carregarAnotacoes(contratoId);
  })
  .catch(err => {
    console.error('‚ùå Erro na exclus√£o:', err);
    alert('Erro ao excluir anota√ß√£o: ' + err.message);
  });
};

// Feedback visual nos bot√µes
function mostrarFeedback(btn, sucesso = true, label = 'Salvando...') {
  const originalHTML = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${label}`;
  
  setTimeout(() => {
    if (sucesso) {
      btn.classList.add('btn-feedback-success');
      btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Sucesso!';
    } else {
      btn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Erro';
    }
    
    setTimeout(() => {
      btn.disabled = false;
      btn.classList.remove('btn-feedback-success');
      btn.innerHTML = originalHTML;
    }, 2000);
  }, 1000);
}

// ===== FUN√á√ïES AUXILIARES PARA ANEXOS =====

// √çcone do arquivo baseado no tipo MIME
function getFileIcon(mimeType) {
  if (mimeType && mimeType.includes('pdf')) return 'bi-file-earmark-pdf text-danger';
  if (mimeType && (mimeType.includes('image'))) return 'bi-file-earmark-image text-success';
  if (mimeType && (mimeType.includes('word') || mimeType.includes('document'))) return 'bi-file-earmark-word text-primary';
  if (mimeType && (mimeType.includes('excel') || mimeType.includes('spreadsheet'))) return 'bi-file-earmark-excel text-success';
  if (mimeType && mimeType.includes('text')) return 'bi-file-earmark-text text-info';
  return 'bi-file-earmark text-secondary';
}

// Formatar tamanho do arquivo
function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Download de anexo
window.downloadAnexo = function(anexoId, nome) {
  console.log('üì• Download anexo:', anexoId, nome);
  window.open(`/contratos/anexos/${anexoId}`, '_blank');
}

// Visualizar PDF (tenta nova aba; se bloqueado, cai para modal inline)
window.visualizarPDF = function(anexoId, nome) {
  const win = window.open(`/contratos/anexos/${anexoId}/inline`, '_blank');
  if (win) return;

  const modalId = 'modalVisualizarPDF';
  document.getElementById(modalId)?.remove();
  document.body.insertAdjacentHTML('beforeend', `
    <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl"><div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-file-earmark-pdf me-2"></i>${nome}</h5>
          <button type="button" class="btn btn-sm btn-light" data-bs-dismiss="modal">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
        <div class="modal-body p-2" style="height:70vh;">
          <iframe src="/contratos/anexos/${anexoId}/inline" width="100%" height="100%" frameborder="0"
                  style="border:1px solid #ddd;border-radius:.375rem;"></iframe>
        </div>
        <div class="modal-footer">
          <a href="/contratos/anexos/${anexoId}" target="_blank" class="btn btn-outline-primary">
            <i class="bi bi-download me-1"></i>Baixar PDF
          </a>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i>Fechar
          </button>
        </div>
      </div></div>
    </div>
  `);
  bootstrap.Modal.getOrCreateInstance(document.getElementById(modalId)).show();
};

// Excluir anexo espec√≠fico
window.excluirAnexo = function(anexoId, anotacaoId, contratoId) {
  console.log('üóëÔ∏è Excluindo anexo:', anexoId, 'da anota√ß√£o:', anotacaoId);
  
  if (!confirm('Tem certeza que deseja excluir este anexo?')) {
    return;
  }
  
  fetch(`/contratos/anexos/${anexoId}`, {
    method: 'DELETE',
    headers: {
      'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('‚úÖ Anexo exclu√≠do com sucesso');
      // Recarregar anota√ß√µes para atualizar a lista
      carregarAnotacoes(contratoId);
    } else {
      console.error('‚ùå Erro ao excluir anexo:', data.error);
      alert('Erro ao excluir anexo: ' + (data.error || 'Erro desconhecido'));
    }
  })
  .catch(error => {
    console.error('‚ùå Erro na requisi√ß√£o:', error);
    alert('Erro ao excluir anexo. Tente novamente.');
  });
}

// Helper para restaurar o bot√£o
function resetBtn(btn) {
  btn.disabled = false;
  btn.classList.remove('btn-feedback-success');
  btn.innerHTML = '<i class="bi bi-send me-1"></i>Enviar';
}

// Salvar anota√ß√£o integrada (texto + anexos)
window.enviarAnotacao = function() {
  console.log('üì§ Enviando anota√ß√£o com anexos...');
  
  const contratoId = document.getElementById('contratoIdAnotacao').value;
  const texto = document.getElementById('anotacaoTexto').value.trim();
  const btn = document.getElementById('btnEnviarAnotacao');
  
  // Verificar anexos na queue
  const uploader = window.uploaderInstance;
  const temAnexos = uploader && uploader.fileQueue.length > 0;
  const temTexto = texto.length > 0;
  
  // Validar se tem algum conte√∫do
  if (!temTexto && !temAnexos) {
    alert('‚ùó Adicione uma mensagem ou anexo para enviar.');
    document.getElementById('anotacaoTexto').focus();
    return;
  }
  
  // Mostrar o que ser√° enviado
  let tipoEnvio = '';
  if (temTexto && temAnexos) {
    tipoEnvio = `mensagem + ${uploader.fileQueue.length} anexo(s)`;
  } else if (temTexto) {
    tipoEnvio = 'apenas mensagem';
  } else if (temAnexos) {
    tipoEnvio = `apenas ${uploader.fileQueue.length} anexo(s)`;
  }
  
  console.log(`üì§ Enviando: ${tipoEnvio}`);
  // estado "enviando"
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
  
  // Preparar FormData com o conte√∫do dispon√≠vel
  const formData = new FormData();
  
  // Adicionar texto se existir
  if (temTexto) {
    formData.append('texto', texto);
  }
  
  // Adicionar arquivos se existirem
  if (temAnexos) {
    uploader.fileQueue.forEach((fileInfo, index) => {
      formData.append('arquivos', fileInfo.file);
    });
  }
  
  // Enviar tudo de uma vez
  fetch(`/contratos/${contratoId}/anotacoes`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      console.log('‚úÖ Enviado com sucesso:', data.anotacao);
      
      // Determinar tipo de conte√∫do enviado para feedback
      const uploader = window.uploaderInstance;
      const temAnexos = uploader && uploader.fileQueue.length > 0;
      const temTexto = document.getElementById('anotacaoTexto').value.trim().length > 0;
      
      let tipoEnvio = '';
      if (temTexto && temAnexos) {
        tipoEnvio = `mensagem + ${uploader.fileQueue.length} anexo(s)`;
      } else if (temTexto) {
        tipoEnvio = 'mensagem';
      } else if (temAnexos) {
        tipoEnvio = `${uploader.fileQueue.length} anexo(s)`;
      }
      
      btn.classList.add('btn-feedback-success');
      btn.innerHTML = `‚úÖ ${tipoEnvio} enviado!`;
      setTimeout(() => finalizarEnvio(btn, contratoId), 1000);
    } else {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Erro ao salvar';
      console.error('‚ùå Erro ao salvar:', data.error);
      alert('Erro: ' + (data.error || 'Erro desconhecido'));
      setTimeout(() => resetBtn(btn), 1200);
    }
  })
  .catch(error => {
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-x-lg me-1"></i>Erro na conex√£o';
    console.error('‚ùå Erro na requisi√ß√£o:', error);
    alert('Erro ao enviar. Verifique sua conex√£o.');
    setTimeout(() => resetBtn(btn), 1200);
  });
}

// Upload sequencial de anexos (n√£o mais usado, mas mantido para compatibilidade)
function uploadAnexosSequencial(contratoId, index, callback) {
  // Esta fun√ß√£o n√£o √© mais usada, mas mantida para evitar erros
  if (callback) callback();
}

// Finalizar envio
function finalizarEnvio(btn, contratoId) {
  // Limpar formul√°rio
  document.getElementById('anotacaoTexto').value = '';
  
  // Limpar queue de anexos
  if (window.uploaderInstance) {
    // se tiver o m√©todo, melhor usar:
    if (typeof window.uploaderInstance.clearQueue === 'function') {
      window.uploaderInstance.clearQueue();
    } else {
      window.uploaderInstance.fileQueue = [];
      const queueContainer = document.querySelector('.file-queue');
      if (queueContainer) queueContainer.innerHTML = '';
    }
  }
  
  // Recarregar anota√ß√µes e restaurar o bot√£o
  carregarAnotacoes(contratoId);
  setTimeout(() => resetBtn(btn), 200);
}

// Fun√ß√£o legacy mantida para compatibilidade
window.salvarAnotacao = window.enviarAnotacao;

// Other utility functions
window.gerarRelatorioContrato = function(contratoId) {
  window.open(`/contratos/${contratoId}/relatorio`, '_blank');
};

window.confirmarExclusao = function(url) {
  if (confirm('Tem certeza que deseja excluir este contrato? Esta a√ß√£o n√£o pode ser desfeita.')) {
    window.location.href = url;
  }
};

</script>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 text-gray-800"><i class="bi bi-file-earmark-text me-2" aria-hidden="true"></i>Gest√£o de Contratos</h1>
    <p class="text-muted mb-0">Gerencie todos os contratos da institui√ß√£o</p>
  </div>
  <div>
    <a href="{{ url_for('contratos_wtf.novo') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle me-1" aria-hidden="true"></i> Novo Contrato
    </a>
  </div>
</div>

<!-- Cards de Estat√≠sticas -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total de Contratos</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ total_contratos if total_contratos is defined else (contratos|length if contratos else 0) }}
            </div>
          </div>
          <div class="col-auto"><i class="bi bi-file-earmark-text fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Contratos Ativos</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              {{ total_ativos if total_ativos is defined else (contratos|selectattr('status','equalto','ATIVO')|list|length if contratos else 0) }}
            </div>
          </div>
          <div class="col-auto"><i class="bi bi-check-circle fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Vencendo em 30 dias</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ vencendo_30 if vencendo_30 is defined else 0 }}</div>
          </div>
          <div class="col-auto"><i class="bi bi-exclamation-triangle fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card border-left-warning shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Valor Total Ativo</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">
              R$ {{ ('%.2f'|format((valor_total_ativo if valor_total_ativo is defined else 0)|float))|replace('.', ',') }}
            </div>
          </div>
          <div class="col-auto"><i class="bi bi-currency-dollar fa-2x text-gray-300" aria-hidden="true"></i></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Filtros -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-funnel me-2" aria-hidden="true"></i>Filtros de Pesquisa</h6>
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-lg-3 col-md-6">
        <label for="empresaFilter" class="form-label">Empresa</label>
        <input type="text" class="form-control" id="empresaFilter" placeholder="Nome da empresa...">
      </div>
      <div class="col-lg-3 col-md-6">
        <label for="statusFilter" class="form-label">Status</label>
        <select class="form-select" id="statusFilter">
          <option value="">Todos os status</option>
          <option value="ATIVO">Ativo</option>
          <option value="INATIVO">Inativo</option>
          <option value="SUSPENSO">Suspenso</option>
          <option value="FINALIZADO">Finalizado</option>
        </select>
      </div>
      <div class="col-lg-2 col-md-6">
        <label for="dataInicioFilter" class="form-label">Data In√≠cio</label>
        <input type="date" class="form-control" id="dataInicioFilter">
      </div>
      <div class="col-lg-2 col-md-6">
        <label for="dataFimFilter" class="form-label">Data Fim</label>
        <input type="date" class="form-control" id="dataFimFilter">
      </div>
      <div class="col-lg-2 col-md-12">
        <button type="button" class="btn btn-outline-secondary w-100" id="limparFiltros">
          <i class="bi bi-arrow-clockwise me-1" aria-hidden="true"></i> Limpar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Tabela -->
<div class="card shadow mb-4">
  <div class="card-header py-3">
    <h6 class="m-0 font-weight-bold text-primary"><i class="bi bi-table me-2" aria-hidden="true"></i>Lista de Contratos</h6>
  </div>
  <div class="card-body">
    {% if contratos %}
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="tabelaContratos">
        <thead class="table-light">
          <tr>
            <th>Empresa</th>
            <th>N√∫mero</th>
            <th>Objeto</th>
            <th>Valor</th>
            <th>Data In√≠cio</th>
            <th>Data Fim</th>
            <th>Status</th>
            <th width="170">A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
        {% for contrato in contratos %}
          <tr>
            <td data-empresa="{{ (contrato.fornecedor or '') | lower }}">{{ contrato.fornecedor or 'N/A' }}</td>
            <td><span class="fw-semibold">{{ contrato.numero_contrato or 'N/A' }}</span></td>
            <td><div class="text-truncate-2" title="{{ contrato.objeto or 'N/A' }}">{{ contrato.objeto or 'N/A' }}</div></td>
            <td>
              <span class="fw-semibold text-success">
                R$
                {% if contrato.valor_total is not none %}
                  {{ "%.2f"|format(contrato.valor_total|float) | replace('.', ',') }}
                {% else %}
                  0,00
                {% endif %}
              </span>
            </td>
            <td data-data="{{ contrato.data_inicio.strftime('%Y-%m-%d') if contrato.data_inicio else '' }}">
              {{ contrato.data_inicio.strftime('%d/%m/%Y') if contrato.data_inicio else 'N/A' }}
            </td>
            <td data-data="{{ contrato.data_fim.strftime('%Y-%m-%d') if contrato.data_fim else '' }}">
              {{ contrato.data_fim.strftime('%d/%m/%Y') if contrato.data_fim else 'N/A' }}
            </td>
            <td data-status="{{ (contrato.status or '') | upper }}">
              {% if contrato.status == 'ATIVO' %}
                <span class="badge bg-success">Ativo</span>
              {% elif contrato.status == 'INATIVO' %}
                <span class="badge bg-secondary">Inativo</span>
              {% elif contrato.status == 'SUSPENSO' %}
                <span class="badge bg-warning text-dark">Suspenso</span>
              {% elif contrato.status == 'FINALIZADO' %}
                <span class="badge bg-info text-dark">Finalizado</span>
              {% else %}
                <span class="badge bg-light text-dark">{{ contrato.status or 'N/A' }}</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group" aria-label="A√ß√µes do contrato {{ contrato.numero_contrato }}">
                <!-- <a href="{{ safe_url_for('contratos.detalhes', id=contrato.id) }}" class="btn btn-outline-info btn-action" title="Visualizar Detalhes">
                  <i class="bi bi-eye" aria-hidden="true"></i><span class="visually-hidden">Detalhes</span>
                </a> -->
                <a href="{{ url_for('contratos_wtf.editar', id=contrato.id) }}" class="btn btn-outline-primary btn-action" title="Editar Contrato">
                  <i class="bi bi-pencil" aria-hidden="true"></i><span class="visually-hidden">Editar</span>
                </a>
                <button type="button" class="btn btn-outline-warning btn-action"
                        onclick='abrirModalAnotacoes({{ contrato.id }}, {{ contrato.numero_contrato|tojson }})'
                        title="Anota√ß√µes e Anexos">
                  <i class="bi bi-journal-text" aria-hidden="true"></i><span class="visually-hidden">Anota√ß√µes</span>
                </button>
                <button type="button" class="btn btn-outline-success btn-action" 
                        onclick="abrirModalAditivos({{ contrato.id }}, '{{ contrato.numero_contrato }}')"
                        title="Adicionar Aditivo">
                  <i class="bi bi-plus-circle" aria-hidden="true"></i><span class="visually-hidden">Aditivo</span>
                </button>
                <button type="button" class="btn btn-outline-secondary btn-action"
                        onclick="gerarRelatorioContrato({{ contrato.id }})"
                        title="Gerar Relat√≥rio">
                  <i class="bi bi-file-earmark-pdf" aria-hidden="true"></i><span class="visually-hidden">Relat√≥rio</span>
                </button>
                <!-- <button type="button" class="btn btn-outline-danger btn-action"
                        onclick="confirmarExclusao('{{ safe_url_for('contratos.excluir', id=contrato.id) }}')"
                        title="Excluir Contrato">
                  <i class="bi bi-trash" aria-hidden="true"></i><span class="visually-hidden">Excluir</span>
                </button> -->
              </div>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <i class="bi bi-file-earmark-text fa-3x text-muted mb-3" aria-hidden="true"></i>
      <h5 class="text-muted">Nenhum contrato encontrado</h5>
      <p class="text-muted">Comece criando um novo contrato.</p>
      <a href="{{ url_for('contratos_wtf.novo') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle me-1" aria-hidden="true"></i> Criar Primeiro Contrato
      </a>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modal de Anota√ß√µes -->
<div class="modal fade" id="modalAnotacoes" tabindex="-1" aria-labelledby="modalAnotacoesLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAnotacoesLabel">
          <i class="bi bi-journal-text me-2"></i>Anota√ß√µes - Contrato
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Coluna Esquerda - Nova Anota√ß√£o -->
          <div class="col-lg-6">
            <h6 class="fw-bold mb-3">
              <i class="bi bi-plus-circle me-2 text-primary"></i>Nova Anota√ß√£o
            </h6>
            
            <form id="formNovaAnotacao">
              <input type="hidden" id="contratoIdAnotacao" name="contrato_id">
              
              <!-- Campo de texto -->
              <div class="mb-3">
                <label for="anotacaoTexto" class="form-label">Texto da Anota√ß√£o *</label>
                <textarea class="form-control" id="anotacaoTexto" name="texto" rows="3" 
                          placeholder="Digite sua anota√ß√£o aqui..." required></textarea>
              </div>
              
              <!-- Professional Uploader -->
              <div id="uploaderContainer">
                <div class="mb-3">
                  <label class="form-label">Anexos (Opcional)</label>
                  
                  <!-- Dropzone Compacta -->
                  <div class="dropzone text-center p-3 mb-2 border rounded">
                    <div class="mb-1">
                      <i class="bi bi-cloud-upload fs-4 text-muted"></i>
                    </div>
                    <p class="mb-1 small fw-semibold">
                      Arraste arquivos aqui ou
                      <button type="button"
                              class="btn btn-link p-0 text-decoration-underline"
                              data-open-picker>
                        clique para selecionar
                      </button>
                    </p>

                    <!-- importante: dentro do mesmo container -->
                    <input type="file" id="anexos" name="anexos" multiple
                           accept=".pdf,.jpg,.jpeg,.png,.gif,.doc,.docx,.xls,.xlsx"
                           class="visually-hidden">
                  </div>
                  
                  <!-- File Queue -->
                  <div class="file-queue"></div>
                </div>
              </div>
              
              <!-- Bot√£o Enviar Integrado -->
              <div class="d-grid">
                <button type="button" class="btn btn-primary" id="btnEnviarAnotacao">
                  <i class="bi bi-send me-1"></i>Enviar
                </button>
              </div>
            </form>
          </div>
          
          <!-- Coluna Direita - Anota√ß√µes Existentes -->
          <div class="col-lg-6">
            <h6 class="fw-bold mb-3">
              <i class="bi bi-list-ul me-2 text-success"></i>Anota√ß√µes Existentes
            </h6>
            <div id="listaAnotacoes" style="max-height: 500px; overflow-y: auto;">
              <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Carregando...</span>
                </div>
                <p class="mt-2 text-muted">Carregando anota√ß√µes...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para visualizar imagens -->
<div class="modal fade" id="modalImg" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Visualizar Imagem</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="imgPreview" src="" class="img-fluid" alt="Preview">
      </div>
    </div>
  </div>
</div>

<script>
// ===== FILTROS CLIENT-SIDE =====
(function () {
  const empresaInput = document.getElementById('empresaFilter');
  const statusSel = document.getElementById('statusFilter');
  const dtIni = document.getElementById('dataInicioFilter');
  const dtFim = document.getElementById('dataFimFilter');
  const btnLimpar = document.getElementById('limparFiltros');
  const tbody = document.querySelector('#tabelaContratos tbody');

  if (!tbody) return;

  const debounce = (fn, ms=200) => { 
    let t; 
    return (...a) => { 
      clearTimeout(t); 
      t = setTimeout(() => fn(...a), ms); 
    }; 
  };

  function aplicaFiltros() {
    const emp = (empresaInput?.value || '').trim().toLowerCase();
    const st = (statusSel?.value || '').trim().toUpperCase();
    const di = dtIni?.value ? new Date(dtIni.value) : null;
    const df = dtFim?.value ? new Date(dtFim.value) : null;

    [...tbody.rows].forEach(tr => {
      const tdEmpresa = tr.querySelector('td[data-empresa]');
      const tdStatus = tr.querySelector('td[data-status]');
      const cols = tr.querySelectorAll('td[data-data]');
      const tdIni = cols[0];
      const tdFim = cols[1];

      const matchEmpresa = emp === '' || (tdEmpresa?.dataset.empresa || '').includes(emp);
      const matchStatus = st === '' || (tdStatus?.dataset.status || '') === st;

      const vIni = tdIni?.dataset.data ? new Date(tdIni.dataset.data) : null;
      const vFim = tdFim?.dataset.data ? new Date(tdFim.dataset.data) : null;

      let matchPeriodo = true;
      if (di && vIni) matchPeriodo = vIni >= di;
      if (matchPeriodo && df && vFim) matchPeriodo = vFim <= df;

      tr.style.display = (matchEmpresa && matchStatus && matchPeriodo) ? '' : 'none';
    });
  }

  empresaInput?.addEventListener('input', debounce(aplicaFiltros));
  statusSel?.addEventListener('change', aplicaFiltros);
  dtIni?.addEventListener('change', aplicaFiltros);
  dtFim?.addEventListener('change', aplicaFiltros);

  btnLimpar?.addEventListener('click', () => {
    if (empresaInput) empresaInput.value = '';
    if (statusSel) statusSel.value = '';
    if (dtIni) dtIni.value = '';
    if (dtFim) dtFim.value = '';
    aplicaFiltros();
  });

  aplicaFiltros();
})();

// ===== FUN√á√ïES PARA MODAL DE ANOTA√á√ïES =====
window.abrirModalAnotacoes = function(contratoId, numeroContrato) {
  console.log('[MODAL] Abrindo modal para contrato:', contratoId, numeroContrato);
  
  const modalEl = document.getElementById('modalAnotacoes');
  if (!modalEl) {
    console.error('[MODAL] Modal n√£o encontrado');
    return;
  }
  
  // Configurar dados do modal
  document.getElementById('contratoIdAnotacao').value = contratoId;
  const labelEl = document.getElementById('modalAnotacoesLabel');
  if (labelEl) {
    labelEl.innerHTML = `<i class="bi bi-journal-text me-2"></i>Anota√ß√µes - Contrato ${numeroContrato}`;
  }
  
  // Reset do formul√°rio
  document.getElementById('formNovaAnotacao').reset();
  
  // Configurar event listener do bot√£o Enviar
  const btnEnviar = document.getElementById('btnEnviarAnotacao');
  if (btnEnviar) {
    // Remove listeners anteriores
    btnEnviar.replaceWith(btnEnviar.cloneNode(true));
    const newBtn = document.getElementById('btnEnviarAnotacao');
    newBtn.addEventListener('click', window.enviarAnotacao);
  }
  
  // Inicializar/Reusar uploader
  if (window.uploaderInstance) {
    window.uploaderInstance.contratoId = contratoId;
    window.uploaderInstance.clearQueue();
  } else {
    window.uploaderInstance = new ProfessionalUploader('uploaderContainer', contratoId);
  }
  
  // Abrir modal e carregar dados
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
  modal.show();
  
  // Carregar anota√ß√µes existentes
  carregarAnotacoes(contratoId);
};

</script>

<!-- Modal para Aditivos -->
<div class="modal fade" id="modalAditivos" tabindex="-1" aria-labelledby="modalAditivosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAditivosLabel">
                    <i class="bi bi-plus-square me-2"></i>
                    Gerenciar Termos Aditivos - <span id="contratoNumero"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Lista de Aditivos Existentes -->
                <div class="mb-4">
                    <h6 class="text-primary border-bottom pb-2">
                        <i class="bi bi-list-check me-1"></i>
                        Aditivos Existentes
                    </h6>
                    <div id="listaAditivos">
                        <!-- Sera preenchido via JavaScript -->
                    </div>
                </div>

                <!-- Formulario para Novo Aditivo -->
                <div class="border-top pt-4">
                    <h6 class="text-success border-bottom pb-2">
                        <i class="bi bi-plus-circle me-1"></i>
                        Adicionar Novo Termo Aditivo
                    </h6>
                    <form id="formNovoAditivo">
                        <input type="hidden" id="contratoId" name="contrato_id">
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="numeroAditivo" class="form-label">Numero do Termo *</label>
                                <select class="form-select" id="numeroAditivo" name="numero_aditivo" required>
                                    <option value="">Selecione...</option>
                                    <option value="1">1¬∞ Termo Aditivo</option>
                                    <option value="2">2¬∞ Termo Aditivo</option>
                                    <option value="3">3¬∞ Termo Aditivo</option>
                                    <option value="4">4¬∞ Termo Aditivo</option>
                                    <option value="5">5¬∞ Termo Aditivo</option>
                                    <option value="6">6¬∞ Termo Aditivo</option>
                                    <option value="7">7¬∞ Termo Aditivo</option>
                                    <option value="8">8¬∞ Termo Aditivo</option>
                                    <option value="9">9¬∞ Termo Aditivo</option>
                                    <option value="10">10¬∞ Termo Aditivo</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="tipoAditivo" class="form-label">Tipo do Aditivo *</label>
                                <select class="form-select" id="tipoAditivo" name="tipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="PRORROGACAO">Prorrogacao de Prazo</option>
                                    <option value="ACRESCIMO">Acrescimo de Valor</option>
                                    <option value="SUPRESSAO">Supressao de Valor</option>
                                    <option value="REAJUSTE">Reajuste de Precos</option>
                                    <option value="ALTERACAO">Alteracao Contratual</option>
                                </select>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label for="dataAditivo" class="form-label">Data do Aditivo *</label>
                                <input type="date" class="form-control" id="dataAditivo" name="data_aditivo" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="valorFinanceiro" class="form-label">Valor Financeiro (R$)</label>
                                <input type="number" class="form-control" id="valorFinanceiro" name="valor_financeiro" 
                                       step="0.01" min="0" placeholder="0,00">
                                <small class="text-muted">Para acrescimos, supressoes ou reajustes</small>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="prazoDias" class="form-label">Prazo (Dias)</label>
                                <input type="number" class="form-control" id="prazoDias" name="prazo_dias" 
                                       min="0" placeholder="0">
                                <small class="text-muted">Para prorrogacoes</small>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <label for="novaDataFim" class="form-label">Nova Data Fim</label>
                                <input type="date" class="form-control" id="novaDataFim" name="nova_data_fim">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="justificativa" class="form-label">Justificativa/Observacoes *</label>
                            <textarea class="form-control" id="justificativa" name="justificativa" 
                                      rows="3" required placeholder="Descreva o motivo do aditivo..."></textarea>
                        </div>
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>
                    Fechar
                </button>
                <button type="button" class="btn btn-success" onclick="salvarAditivo()">
                    <i class="bi bi-check-circle me-1"></i>
                    Salvar Aditivo
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/aditivos-modal.js') }}"></script>

{% endblock %}



{% extends "base.html" %}

{% block title %}{{ 'Editar' if contrato else 'Novo' }} Contrato - Gest√£o de Empenhos e Contratos{% endblock %}

{% block page_title %}{{ 'Editar' if contrato else 'Novo' }} Contrato{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <a href="{{ url_for('contratos.index') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>
        Voltar
    </a>
    {% if contrato %}
    <a href="{{ url_for('contratos.detalhes', id=contrato.id) }}" class="btn btn-outline-primary">
        <i class="bi bi-eye me-1"></i>
        Ver Detalhes
    </a>
    {% endif %}
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-{{ 'pencil' if contrato else 'plus-circle' }} me-2"></i>
                    {{ 'Editar' if contrato else 'Criar Novo' }} Contrato
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="formContrato">
                    <!-- Identificacao do Contrato -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-card-heading me-1"></i>
                                Identificacao do Contrato
                            </h6>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="numero_pregao" class="form-label">Numero do Pregao *</label>
                            <input type="text" class="form-control" id="numero_pregao" name="numero_pregao" 
                                   value="{{ contrato.numero_pregao if contrato else '' }}" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="numero_contrato" class="form-label">Numero do Contrato *</label>
                            <input type="text" class="form-control" id="numero_contrato" name="numero_contrato" 
                                   value="{{ contrato.numero_contrato if contrato else '' }}" required>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="numero_ctr" class="form-label">Numero CTR</label>
                            <input type="text" class="form-control" id="numero_ctr" name="numero_ctr" 
                                   value="{{ contrato.numero_ctr if contrato else '' }}">
                        </div>
                    </div>

                    <!-- Objeto e Fornecedor -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-building me-1"></i>
                                Objeto e Fornecedor
                            </h6>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="objeto" class="form-label">Objeto do Contrato *</label>
                            <textarea class="form-control" id="objeto" name="objeto" rows="3" required>{{ contrato.objeto if contrato else '' }}</textarea>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="resumo_objeto" class="form-label">Resumo do Objeto</label>
                            <textarea class="form-control" id="resumo_objeto" name="resumo_objeto" rows="2">{{ contrato.resumo_objeto if contrato else '' }}</textarea>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="fornecedor" class="form-label">Fornecedor *</label>
                            <input type="text" class="form-control" id="fornecedor" name="fornecedor" 
                                   value="{{ contrato.fornecedor if contrato else '' }}" required>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="valor_total" class="form-label">Valor Total *</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="valor_total" name="valor_total" 
                                       step="0.01" min="0" value="{{ contrato.valor_total if contrato else '' }}" required>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="valor_inicial" class="form-label">Valor Inicial</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="valor_inicial" name="valor_inicial" 
                                       step="0.01" min="0" value="{{ contrato.valor_inicial if contrato else '' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Datas do Contrato -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-calendar me-1"></i>
                                Prazos e Datas
                            </h6>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="data_assinatura" class="form-label">Data de Assinatura *</label>
                            <input type="date" class="form-control" id="data_assinatura" name="data_assinatura" 
                                   value="{{ contrato.data_assinatura.strftime('%Y-%m-%d') if contrato and contrato.data_assinatura else '' }}" required>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="data_inicio" class="form-label">Data de Inicio *</label>
                            <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                                   value="{{ contrato.data_inicio.strftime('%Y-%m-%d') if contrato and contrato.data_inicio else '' }}" required>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="data_fim" class="form-label">Data de Fim *</label>
                            <input type="date" class="form-control" id="data_fim" name="data_fim" 
                                   value="{{ contrato.data_fim.strftime('%Y-%m-%d') if contrato and contrato.data_fim else '' }}" required>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="data_fim_original" class="form-label">Data de Fim Original</label>
                            <input type="date" class="form-control" id="data_fim_original" name="data_fim_original" 
                                   value="{{ contrato.data_fim_original.strftime('%Y-%m-%d') if contrato and contrato.data_fim_original else '' }}">
                        </div>
                    </div>

                    <!-- Gestao e Controle -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-people me-1"></i>
                                Gestao e Controle
                            </h6>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="gestor_fiscal" class="form-label">Gestor Fiscal</label>
                            <input type="text" class="form-control" id="gestor_fiscal" name="gestor_fiscal" 
                                   value="{{ contrato.gestor_fiscal if contrato else '' }}">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="gestor_superior" class="form-label">Gestor Superior</label>
                            <input type="text" class="form-control" id="gestor_superior" name="gestor_superior" 
                                   value="{{ contrato.gestor_superior if contrato else '' }}">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="status" class="form-label">Status *</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="">Selecione...</option>
                                <option value="ATIVO" {{ 'selected' if contrato and contrato.status == 'ATIVO' else '' }}>Ativo</option>
                                <option value="SUSPENSO" {{ 'selected' if contrato and contrato.status == 'SUSPENSO' else '' }}>Suspenso</option>
                                <option value="ENCERRADO" {{ 'selected' if contrato and contrato.status == 'ENCERRADO' else '' }}>Encerrado</option>
                                <option value="RESCINDIDO" {{ 'selected' if contrato and contrato.status == 'RESCINDIDO' else '' }}>Rescindido</option>
                            </select>
                        </div>
                    </div>

                    <!-- Informacoes Municipais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-building-check me-1"></i>
                                Informacoes Municipais
                            </h6>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="modalidade_licitacao" class="form-label">Modalidade de Licitacao</label>
                            <select class="form-select" id="modalidade_licitacao" name="modalidade_licitacao">
                                <option value="">Selecione...</option>
                                <option value="PREGAO" {{ 'selected' if contrato and contrato.modalidade_licitacao == 'PREGAO' else '' }}>Pregao</option>
                                <option value="TOMADA_PRECOS" {{ 'selected' if contrato and contrato.modalidade_licitacao == 'TOMADA_PRECOS' else '' }}>Tomada de Precos</option>
                                <option value="CONCORRENCIA" {{ 'selected' if contrato and contrato.modalidade_licitacao == 'CONCORRENCIA' else '' }}>Concorrencia</option>
                                <option value="CONVITE" {{ 'selected' if contrato and contrato.modalidade_licitacao == 'CONVITE' else '' }}>Convite</option>
                                <option value="DISPENSA" {{ 'selected' if contrato and contrato.modalidade_licitacao == 'DISPENSA' else '' }}>Dispensa</option>
                                <option value="INEXIGIBILIDADE" {{ 'selected' if contrato and contrato.modalidade_licitacao == 'INEXIGIBILIDADE' else '' }}>Inexigibilidade</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="numero_processo" class="form-label">Numero do Processo</label>
                            <input type="text" class="form-control" id="numero_processo" name="numero_processo" 
                                   value="{{ contrato.numero_processo if contrato else '' }}">
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="lei_base" class="form-label">Lei Base</label>
                            <input type="text" class="form-control" id="lei_base" name="lei_base" 
                                   value="{{ contrato.lei_base if contrato else '' }}" placeholder="Ex: Lei 14.133/2021">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="orgao_contratante" class="form-label">Orgao Contratante</label>
                            <input type="text" class="form-control" id="orgao_contratante" name="orgao_contratante" 
                                   value="{{ contrato.orgao_contratante if contrato else '' }}">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="secretaria" class="form-label">Secretaria</label>
                            <input type="text" class="form-control" id="secretaria" name="secretaria" 
                                   value="{{ contrato.secretaria if contrato else '' }}">
                        </div>
                    </div>

                    <!-- Garantias e Seguros -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-shield-check me-1"></i>
                                Garantias e Seguros
                            </h6>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="tipo_garantia" class="form-label">Tipo de Garantia</label>
                            <select class="form-select" id="tipo_garantia" name="tipo_garantia">
                                <option value="">Sem garantia</option>
                                <option value="CAUCAO" {{ 'selected' if contrato and contrato.tipo_garantia == 'CAUCAO' else '' }}>Caucao</option>
                                <option value="SEGURO_GARANTIA" {{ 'selected' if contrato and contrato.tipo_garantia == 'SEGURO_GARANTIA' else '' }}>Seguro-garantia</option>
                                <option value="FIANCA_BANCARIA" {{ 'selected' if contrato and contrato.tipo_garantia == 'FIANCA_BANCARIA' else '' }}>Fianca Bancaria</option>
                            </select>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="valor_garantia" class="form-label">Valor da Garantia</label>
                            <div class="input-group">
                                <span class="input-group-text">R$</span>
                                <input type="number" class="form-control" id="valor_garantia" name="valor_garantia" 
                                       step="0.01" min="0" value="{{ contrato.valor_garantia if contrato else '' }}">
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="validade_garantia" class="form-label">Validade da Garantia</label>
                            <input type="date" class="form-control" id="validade_garantia" name="validade_garantia" 
                                   value="{{ contrato.validade_garantia.strftime('%Y-%m-%d') if contrato and contrato.validade_garantia else '' }}">
                        </div>
                    </div>

                    <!-- Observacoes -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="bi bi-chat-text me-1"></i>
                                Observacoes
                            </h6>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label for="observacoes" class="form-label">Observacoes Gerais</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3">{{ contrato.observacoes if contrato else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Botoes de Acao -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('contratos.index') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Cancelar
                                </a>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle me-1"></i>
                                        {{ 'Atualizar' if contrato else 'Salvar' }} Contrato
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Validacao do formulario -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('formContrato');
    
    // Validacao basica
    form.addEventListener('submit', function(e) {
        const numeroContrato = document.getElementById('numero_contrato').value.trim();
        const objeto = document.getElementById('objeto').value.trim();
        const fornecedor = document.getElementById('fornecedor').value.trim();
        const valorTotal = document.getElementById('valor_total').value;
        
        if (!numeroContrato || !objeto || !fornecedor || !valorTotal) {
            e.preventDefault();
            alert('Por favor, preencha todos os campos obrigatorios marcados com *');
            return false;
        }
        
        // Validar datas
        const dataInicio = new Date(document.getElementById('data_inicio').value);
        const dataFim = new Date(document.getElementById('data_fim').value);
        
        if (dataFim <= dataInicio) {
            e.preventDefault();
            alert('A data de fim deve ser posterior a data de inicio.');
            return false;
        }
    });
    
    // Auto-preenchimento do valor inicial se estiver vazio
    const valorTotal = document.getElementById('valor_total');
    const valorInicial = document.getElementById('valor_inicial');
    
    valorTotal.addEventListener('blur', function() {
        if (this.value && !valorInicial.value) {
            valorInicial.value = this.value;
        }
    });
});
</script>
{% endblock %}

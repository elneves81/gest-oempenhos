{% extends "base.html" %}
{% block title %}Empenhar – {{ c.numero }}{% endblock %}
{% block page_title %}Empenhar no Contrato {{ c.numero }}{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h6 class="mb-0">Situação do Contrato</h6>
  </div>
  <div class="card-body">
    <div class="alert alert-info">
      <div class="row text-center">
        <div class="col-md-3">
          <strong>Valor Atualizado</strong><br>
          <span class="h5 text-primary">R$ {{ '{:,.2f}'.format(c.valor_atualizado).replace(',', 'X').replace('.', ',').replace('X','.') }}</span>
        </div>
        <div class="col-md-3">
          <strong>Empenhado</strong><br>
          <span class="h5 text-warning">R$ {{ '{:,.2f}'.format(c.empenhado_contrato).replace(',', 'X').replace('.', ',').replace('X','.') }}</span>
        </div>
        <div class="col-md-3">
          <strong>Saldo Disponível</strong><br>
          <span class="h5 text-success">R$ {{ '{:,.2f}'.format(c.saldo_contrato).replace(',', 'X').replace('.', ',').replace('X','.') }}</span>
        </div>
        <div class="col-md-3">
          <strong>Fornecedor</strong><br>
          <span class="h6">{{ c.fornecedor }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<form method="post" class="card mt-3">
  <div class="card-header">
    <h6 class="mb-0">Dados do Empenho</h6>
  </div>
  <div class="card-body row g-3">
    <div class="col-md-3">
      <label class="form-label">Nº Empenho *</label>
      <input name="numero" class="form-control" required placeholder="Ex: 2025/001">
    </div>
    
    <div class="col-md-5">
      <label class="form-label">Fornecedor *</label>
      <input name="fornecedor" class="form-control" required value="{{ c.fornecedor }}">
    </div>
    
    <div class="col-md-2">
      <label class="form-label">Valor *</label>
      <div class="input-group">
        <span class="input-group-text">R$</span>
        <input type="number" step="0.01" name="valor" class="form-control" required 
               max="{{ c.saldo_contrato }}">
      </div>
    </div>
    
    <div class="col-md-2">
      <label class="form-label">Ano</label>
      <input type="number" class="form-control" id="f-ano" 
             value="{{ c.data_inicio.year if c.data_inicio else '2025' }}">
    </div>
    
    <div class="col-12">
      <label class="form-label">Linha Orçamentária</label>
      <select id="orcamento" name="orcamento_id" class="form-select">
        {% if c.orcamento_id %}
        <option value="{{ c.orcamento_id }}" selected>Orçamento do Contrato</option>
        {% endif %}
      </select>
      <div class="form-text">
        Se não selecionado, usará a linha orçamentária principal do contrato
        {% if not c.orcamento_id %}
        <span class="text-warning">(não definida - será obrigatório selecionar)</span>
        {% endif %}
      </div>
    </div>
    
    <div class="col-12">
      <label class="form-label">Descrição (opcional)</label>
      <textarea name="descricao" class="form-control" rows="2" 
                placeholder="Descrição adicional do empenho...">{{ c.objeto or '' }}</textarea>
    </div>
    
    <div class="col-12 text-end">
      <a href="{{ url_for('ui_contr.contr_list') }}" class="btn btn-outline-secondary">Cancelar</a>
      <button class="btn btn-primary">
        <i class="bi bi-cash-coin me-1"></i>Empenhar
      </button>
    </div>
  </div>
</form>

<div class="alert alert-warning mt-3">
  <i class="bi bi-exclamation-triangle me-2"></i>
  <strong>Atenção:</strong> O empenho será descontado automaticamente do saldo do contrato 
  e da linha orçamentária selecionada.
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.full.min.js"></script>
<script>
$(function(){
  function buildUrl(params) { 
    const ano = $('#f-ano').val() || ''; 
    const q = params.term || ''; 
    return `/api/orcamentos/search?q=${encodeURIComponent(q)}&ano=${encodeURIComponent(ano)}`; 
  }
  
  $('#orcamento').select2({ 
    theme: 'bootstrap-5',
    placeholder: 'Buscar linha orçamentária...',
    allowClear: true,
    ajax: { 
      delay: 300, 
      transport: function(params, success, failure) {
        return $.getJSON(buildUrl(params.data)).then(success).catch(failure);
      }, 
      processResults: function(data) {
        return data;
      } 
    }, 
    width: '100%',
    minimumInputLength: 0
  });
  
  $('#f-ano').on('change', function() {
    $('#orcamento').val(null).trigger('change');
  });
});
</script>
{% endblock %}

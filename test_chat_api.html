<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Chat REST API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .messages { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin: 10px 0; }
        .message { margin: 5px 0; padding: 5px; background: #f5f5f5; border-radius: 5px; }
        .input-group { display: flex; gap: 10px; }
        .input-group input { flex: 1; padding: 8px; }
        .input-group button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Teste Chat REST API</h1>
        
        <div class="status" id="status">
            Conectando...
        </div>
        
        <div>
            <label>Room ID: <input type="number" id="roomId" value="1" min="1"></label>
            <button onclick="loadMessages()">🔄 Carregar Mensagens</button>
        </div>
        
        <div class="messages" id="messages">
            <!-- Mensagens aparecerão aqui -->
        </div>
        
        <div class="input-group">
            <input type="text" id="messageInput" placeholder="Digite sua mensagem..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()">📤 Enviar</button>
        </div>
        
        <h3>🧪 Testes das Rotas</h3>
        <div>
            <button onclick="testOldRoute()">🔄 Testar Rota Antiga (/send_message)</button>
            <button onclick="testNewRoute()">🚀 Testar Rota Nova (/rooms/{id}/messages)</button>
        </div>
    </div>

    <script>
        // Configuração
        const API_BASE = '/chat-offline';
        
        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${isError ? 'error' : 'success'}`;
        }
        
        function addMessage(msg) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = 'message';
            div.innerHTML = `
                <strong>${msg.username || 'Usuário'}:</strong> 
                ${msg.content || msg.message || 'Mensagem vazia'}
                <small>(${new Date(msg.created_at || msg.timestamp).toLocaleString()})</small>
            `;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        async function loadMessages() {
            const roomId = document.getElementById('roomId').value;
            if (!roomId) {
                updateStatus('Room ID é obrigatório', true);
                return;
            }
            
            try {
                updateStatus('Carregando mensagens...');
                
                // Usar nova rota padronizada
                const response = await fetch(`${API_BASE}/rooms/${roomId}/messages`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // Limpar mensagens antigas
                document.getElementById('messages').innerHTML = '';
                
                // Adicionar mensagens
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(addMessage);
                    updateStatus(`✅ ${data.messages.length} mensagens carregadas`);
                } else {
                    updateStatus('📭 Nenhuma mensagem encontrada');
                }
                
            } catch (error) {
                updateStatus(`❌ Erro ao carregar mensagens: ${error.message}`, true);
                console.error('Erro:', error);
            }
        }
        
        async function sendMessage() {
            const roomId = document.getElementById('roomId').value;
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!roomId) {
                updateStatus('Room ID é obrigatório', true);
                return;
            }
            
            if (!content) {
                updateStatus('Mensagem não pode estar vazia', true);
                return;
            }
            
            try {
                updateStatus('Enviando mensagem...');
                
                // Usar nova rota padronizada
                const response = await fetch(`${API_BASE}/rooms/${roomId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ content: content })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Adicionar mensagem à interface
                addMessage(data);
                
                // Limpar input
                input.value = '';
                
                updateStatus('✅ Mensagem enviada!');
                
            } catch (error) {
                updateStatus(`❌ Erro ao enviar mensagem: ${error.message}`, true);
                console.error('Erro:', error);
            }
        }
        
        async function testOldRoute() {
            const roomId = document.getElementById('roomId').value;
            
            try {
                updateStatus('🧪 Testando rota antiga...');
                
                const response = await fetch(`${API_BASE}/send_message`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ 
                        room_id: roomId, 
                        message: `Teste rota antiga: ${new Date().toLocaleTimeString()}` 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('✅ Rota antiga funcionando!');
                    if (data.message) addMessage(data.message);
                } else {
                    updateStatus(`❌ Rota antiga falhou: ${data.error}`, true);
                }
                
            } catch (error) {
                updateStatus(`❌ Erro na rota antiga: ${error.message}`, true);
            }
        }
        
        async function testNewRoute() {
            const roomId = document.getElementById('roomId').value;
            
            try {
                updateStatus('🚀 Testando rota nova...');
                
                const response = await fetch(`${API_BASE}/rooms/${roomId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ 
                        content: `Teste rota nova: ${new Date().toLocaleTimeString()}` 
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('✅ Rota nova funcionando!');
                    addMessage(data);
                } else {
                    const error = await response.json();
                    updateStatus(`❌ Rota nova falhou: ${error.error}`, true);
                }
                
            } catch (error) {
                updateStatus(`❌ Erro na rota nova: ${error.message}`, true);
            }
        }
        
        // Carregar mensagens ao inicializar
        window.onload = () => {
            updateStatus('✅ Sistema inicializado');
            loadMessages();
        };
    </script>
</body>
</html>
